<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT ‚Äì Dashboard de M√©tricas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
    
    /* HEADER PADRONIZADO */
    header { 
      background-color: #e07b3c; 
      color: white; 
      padding: 20px 30px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header-title { 
      font-size: 24px; 
      font-weight: bold; 
    }
    .header-badges { 
      display: flex; 
      gap: 10px; 
      align-items: center;
    }
    .badge { 
      padding: 6px 14px; 
      border-radius: 4px;
      font-size: 13px; 
      font-weight: 600; 
      background: rgba(255,255,255,0.2);
    }
    .badge-cha { 
      background: #28a745; 
    }
    .badge-ia { 
      background: #4caf50; 
    }
    
    .container { padding: 30px; max-width: 1600px; margin: 0 auto; }
    
    .loading { text-align: center; color: #333; font-size: 18px; padding: 50px; }
    .error { background: #f44336; color: white; padding: 20px; text-align: center; margin: 20px 0; border-left: 4px solid #c62828; }
    
    /* Grid de Cards de M√©tricas */
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: white; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: box-shadow 0.2s; border-left: 4px solid #e07b3c; }
    .metric-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .metric-icon { font-size: 32px; margin-bottom: 10px; }
    .metric-value { font-size: 36px; font-weight: bold; color: #e07b3c; margin: 10px 0; }
    .metric-label { font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-change { font-size: 12px; margin-top: 8px; padding: 4px 8px; display: inline-block; }
    .metric-change.positive { background: #e8f5e9; color: #2e7d32; }
    .metric-change.negative { background: #ffebee; color: #c62828; }
    
    /* Se√ß√µes de Gr√°ficos */
    .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .chart-card { background: white; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .chart-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e07b3c; padding-bottom: 10px; }
    .chart-container { position: relative; height: 300px; }
    
    /* Tabelas de Ranking */
    .ranking-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .ranking-card { background: white; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .ranking-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #e07b3c; padding-bottom: 10px; }
    .ranking-title.top { color: #28a745; border-bottom-color: #28a745; }
    .ranking-title.bottom { color: #f44336; border-bottom-color: #f44336; }
    
    .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: #f8f9fa; transition: background 0.2s; border-left: 3px solid transparent; }
    .ranking-item:hover { background: #e9ecef; border-left-color: #e07b3c; }
    .ranking-position { font-weight: bold; font-size: 18px; width: 30px; text-align: center; }
    .ranking-position.gold { color: #ffd700; }
    .ranking-position.silver { color: #c0c0c0; }
    .ranking-position.bronze { color: #cd7f32; }
    .ranking-position.danger { color: #f44336; }
    .ranking-info { flex: 1; padding: 0 15px; }
    .ranking-name { font-weight: 600; color: #333; }
    .ranking-dept { font-size: 12px; color: #666; }
    .ranking-score { font-weight: bold; font-size: 18px; color: #e07b3c; }
    
    /* Se√ß√£o de Bonifica√ß√µes */
    .bonificacoes-overview { background: white; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .bonif-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .bonif-item { background: #e07b3c; color: white; padding: 20px; text-align: center; }
    .bonif-value { font-size: 28px; font-weight: bold; margin: 10px 0; }
    .bonif-label { font-size: 13px; opacity: 0.9; }
    
    /* Distribui√ß√£o por Departamento */
    .dept-distribution { background: white; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .dept-list { display: grid; gap: 12px; margin-top: 20px; }
    .dept-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f9fa; }
    .dept-name { font-weight: 600; width: 150px; }
    .dept-bar-container { flex: 1; background: #e0e0e0; height: 30px; overflow: hidden; position: relative; }
    .dept-bar { height: 100%; background: #e07b3c; transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: 600; font-size: 12px; }
    .dept-count { font-weight: bold; width: 50px; text-align: right; color: #e07b3c; }
    
    /* BOT√ïES FIXOS PADRONIZADOS */
    .action-buttons { 
      position: fixed; 
      bottom: 30px; 
      right: 30px; 
      display: flex; 
      gap: 10px; 
      z-index: 1000; 
    }
    .btn-action { 
      padding: 12px 24px; 
      border: none; 
      border-radius: 4px;
      font-weight: 600; 
      font-size: 14px;
      cursor: pointer; 
      transition: all 0.2s; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-action:hover { 
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
      transform: translateY(-1px);
    }
    .btn-refresh { 
      background-color: #28a745; 
      color: white; 
    }
    .btn-refresh:hover { 
      background-color: #218838; 
    }
    .btn-reports { 
      background-color: #2196F3; 
      color: white; 
    }
    .btn-reports:hover { 
      background-color: #1976d2; 
    }
    .btn-back { 
      background-color: #e07b3c; 
      color: white; 
    }
    .btn-back:hover { 
      background-color: #cf6a2b; 
    }
    
    @media (max-width: 1200px) {
      .charts-section { grid-template-columns: 1fr; }
      .ranking-section { grid-template-columns: 1fr; }
    }
    
    @media (max-width: 768px) {
      .metrics-grid { grid-template-columns: 1fr; }
      .action-buttons { 
        bottom: 20px; 
        right: 20px; 
        flex-direction: column; 
      }
      .header-badges {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-title">FYT ‚Äì Find Your Talent</div>
    <div class="header-badges">
      <span class="badge badge-cha">M√©todo CHA</span>
      <span class="badge badge-ia" id="badgeIA">IA Ativa</span>
    </div>
  </header>

  <div class="container">
    <div id="loadingContainer" class="loading">Carregando dados da dashboard...</div>
    <div id="errorContainer"></div>
    <div id="dashboardContent" style="display: none;">
      
      <!-- M√©tricas Principais -->
      <div class="metrics-grid" id="metricsGrid"></div>
      
      <!-- Gr√°ficos -->
      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-title">
            <span>Distribui√ß√£o de Scores CHA</span>
          </div>
          <div class="chart-container">
            <canvas id="scoresChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-title">
            <span>M√©dia CHA por Dimens√£o</span>
          </div>
          <div class="chart-container">
            <canvas id="chaChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Rankings -->
      <div class="ranking-section">
        <div class="ranking-card">
          <div class="ranking-title top">
            Top 10 Melhores Desempenhos
          </div>
          <div id="topRanking"></div>
        </div>
        
        <div class="ranking-card">
          <div class="ranking-title bottom">
            10 Menores Desempenhos
          </div>
          <div id="bottomRanking"></div>
        </div>
      </div>
      
      <!-- Bonifica√ß√µes Overview -->
      <div class="bonificacoes-overview">
        <div class="chart-title">Resumo de Bonifica√ß√µes</div>
        <div class="bonif-grid" id="bonifGrid"></div>
      </div>
      
      <!-- Distribui√ß√£o por Departamento -->
      <div class="dept-distribution">
        <div class="chart-title">Funcion√°rios por Departamento</div>
        <div class="dept-list" id="deptList"></div>
      </div>
      
      <!-- Gr√°fico de Bonifica√ß√µes -->
      <div class="chart-card">
        <div class="chart-title">
          <span>Bonifica√ß√µes por Categoria</span>
        </div>
        <div class="chart-container">
          <canvas id="bonifChart"></canvas>
        </div>
      </div>
      
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn-action btn-refresh" onclick="location.reload()">
      üîÑ Atualizar
    </button>
    <button class="btn-action btn-reports" onclick="window.location.href='{{ url_for('dados')}}'">
      üìã Relat√≥rios
    </button>
    <button class="btn-action btn-back" onclick="window.location.href='{{ url_for('upload')}}'">
      ‚¨ÖÔ∏è Enviar outro arquivo
    </button>
  </div>

  <script>
    let chartsInstances = {};

    function calcularScore(func) {
      const conceito = parseFloat(func["Conceito (1-5 Likert)"] || func["Conceito"] || 0);
      const habilidade = parseFloat(func["Habilidade (1-5 Likert)"] || func["Habilidade"] || 0);
      const atitude = parseFloat(func["Atitude (1-5 Likert)"] || func["Atitude"] || 0);
      return conceito + habilidade + atitude;
    }

    function renderMetrics(data) {
      const relatorios = data.relatorios || {};
      const bonificacoes = data.bonificacoes_com_hobbies || data.bonificacoes || {};
      
      let todosFuncionarios = [];
      for (const dept in relatorios) {
        if (Array.isArray(relatorios[dept])) {
          todosFuncionarios = todosFuncionarios.concat(relatorios[dept]);
        }
      }
      
      const totalFuncionarios = todosFuncionarios.length;
      const totalDepartamentos = Object.keys(relatorios).length;
      
      const scores = todosFuncionarios.map(f => calcularScore(f));
      const mediaScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
      const maxScore = Math.max(...scores, 0);
      const minScore = Math.min(...scores, 15);
      
      let totalBonificacoes = 0;
      let valorTotalBonif = 0;
      let bonifComIA = 0;
      
      for (const dept in bonificacoes) {
        if (Array.isArray(bonificacoes[dept])) {
          bonificacoes[dept].forEach(b => {
            totalBonificacoes++;
            valorTotalBonif += parseFloat(b["Valor Sugerido (R$)"] || 0);
            if (b["Bonifica√ß√£o Sugerida"] || b["Bonifica√É¬ß√É¬£o Sugerida"]) {
              bonifComIA++;
            }
          });
        }
      }
      
      const metrics = [
        { icon: 'üë•', value: totalFuncionarios, label: 'Total de Funcion√°rios', change: null },
        { icon: 'üè¢', value: totalDepartamentos, label: 'Departamentos', change: null },
        { icon: 'üìä', value: mediaScore.toFixed(2), label: 'M√©dia Score CHA', change: null },
        { icon: '‚≠ê', value: maxScore.toFixed(2), label: 'Maior Score', change: null },
        { icon: 'üí∞', value: totalBonificacoes, label: 'Bonifica√ß√µes Atribu√≠das', change: null },
        { icon: 'üíµ', value: `R$ ${valorTotalBonif.toFixed(0)}`, label: 'Valor Total Bonifica√ß√µes', change: null },
        { icon: 'ü§ñ', value: bonifComIA, label: 'An√°lises por IA', change: bonifComIA > 0 ? { type: 'positive', text: 'IA Ativa' } : null },
        { icon: 'üìâ', value: minScore.toFixed(2), label: 'Menor Score', change: null }
      ]; 
      
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = metrics.map(m => `
        <div class="metric-card">
          <div class="metric-icon">${m.icon}</div>
          <div class="metric-value">${m.value}</div>
          <div class="metric-label">${m.label}</div>
          ${m.change ? `<div class="metric-change ${m.change.type}">${m.change.text}</div>` : ''}
        </div>
      `).join('');
    }

    function renderScoresChart(data) {
      const relatorios = data.relatorios || {};
      let todosFuncionarios = [];
      for (const dept in relatorios) {
        if (Array.isArray(relatorios[dept])) {
          todosFuncionarios = todosFuncionarios.concat(relatorios[dept]);
        }
      }
      
      const scores = todosFuncionarios.map(f => calcularScore(f));
      
      const faixas = {
        '0-3': 0,
        '3-6': 0,
        '6-9': 0,
        '9-12': 0,
        '12-15': 0
      };
      
      scores.forEach(s => {
        if (s < 3) faixas['0-3']++;
        else if (s < 6) faixas['3-6']++;
        else if (s < 9) faixas['6-9']++;
        else if (s < 12) faixas['9-12']++;
        else faixas['12-15']++;
      });
      
      const ctx = document.getElementById('scoresChart');
      if (chartsInstances.scoresChart) chartsInstances.scoresChart.destroy();
      chartsInstances.scoresChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(faixas),
          datasets: [{
            label: 'Quantidade de Funcion√°rios',
            data: Object.values(faixas),
            backgroundColor: 'rgba(224, 123, 60, 0.7)',
            borderColor: 'rgba(224, 123, 60, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    function renderCHAChart(data) {
      const relatorios = data.relatorios || {};
      let todosFuncionarios = [];
      for (const dept in relatorios) {
        if (Array.isArray(relatorios[dept])) {
          todosFuncionarios = todosFuncionarios.concat(relatorios[dept]);
        }
      }
      
      const conceitos = todosFuncionarios.map(f => parseFloat(f["Conceito (1-5 Likert)"] || 0));
      const habilidades = todosFuncionarios.map(f => parseFloat(f["Habilidade (1-5 Likert)"] || 0));
      const atitudes = todosFuncionarios.map(f => parseFloat(f["Atitude (1-5 Likert)"] || 0));
      
      const mediaConceito = conceitos.reduce((a, b) => a + b, 0) / conceitos.length || 0;
      const mediaHabilidade = habilidades.reduce((a, b) => a + b, 0) / habilidades.length || 0;
      const mediaAtitude = atitudes.reduce((a, b) => a + b, 0) / atitudes.length || 0;
      
      const ctx = document.getElementById('chaChart');
      if (chartsInstances.chaChart) chartsInstances.chaChart.destroy();
      chartsInstances.chaChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Conceito (Conhecimento)', 'Habilidade', 'Atitude'],
          datasets: [{
            label: 'M√©dia Geral',
            data: [mediaConceito, mediaHabilidade, mediaAtitude],
            backgroundColor: 'rgba(224, 123, 60, 0.2)',
            borderColor: 'rgba(224, 123, 60, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(224, 123, 60, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(224, 123, 60, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 5,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function renderRankings(data) {
      const relatorios = data.relatorios || {};
      let todosFuncionarios = [];
      
      for (const dept in relatorios) {
        if (Array.isArray(relatorios[dept])) {
          relatorios[dept].forEach(f => {
            todosFuncionarios.push({
              ...f,
              departamento: dept,
              score: calcularScore(f)
            });
          });
        }
      }
      
      todosFuncionarios.sort((a, b) => b.score - a.score);
      
      const top10 = todosFuncionarios.slice(0, 10);
      const bottom10 = todosFuncionarios.slice(-10).reverse();
      
      const topRanking = document.getElementById('topRanking');
      topRanking.innerHTML = top10.map((f, i) => {
        const posClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
          <div class="ranking-item">
            <div class="ranking-position ${posClass}">${i + 1}¬∫</div>
            <div class="ranking-info">
              <div class="ranking-name">${f["Nome Completo"] || 'N/A'}</div>
              <div class="ranking-dept">${f.departamento} ‚Ä¢ ${f["Cargo"] || 'N/A'}</div>
            </div>
            <div class="ranking-score">${f.score.toFixed(2)}</div>
          </div>
        `;
      }).join('');
      
      const bottomRanking = document.getElementById('bottomRanking');
      bottomRanking.innerHTML = bottom10.map((f, i) => {
        return `
          <div class="ranking-item">
            <div class="ranking-position danger">${bottom10.length - i}</div>
            <div class="ranking-info">
              <div class="ranking-name">${f["Nome Completo"] || 'N/A'}</div>
              <div class="ranking-dept">${f.departamento} ‚Ä¢ ${f["Cargo"] || 'N/A'}</div>
            </div>
            <div class="ranking-score">${f.score.toFixed(2)}</div>
          </div>
        `;
      }).join('');
    }

    function renderBonificacoes(data) {
      const bonificacoes = data.bonificacoes_com_hobbies || data.bonificacoes || {};
      
      let totalBonif = 0;
      let valorTotal = 0;
      let comIA = 0;
      const categorias = {};
      
      for (const dept in bonificacoes) {
        if (Array.isArray(bonificacoes[dept])) {
          bonificacoes[dept].forEach(b => {
            totalBonif++;
            valorTotal += parseFloat(b["Valor Sugerido (R$)"] || 0);
            if (b["Bonifica√ß√£o Sugerida"]) comIA++;
            
            const cat = b["Categoria"] || "Outros";
            categorias[cat] = (categorias[cat] || 0) + 1;
          });
        }
      }
      
      const valorMedio = totalBonif > 0 ? valorTotal / totalBonif : 0;
      
      const bonifGrid = document.getElementById('bonifGrid');
      bonifGrid.innerHTML = `
        <div class="bonif-item">
          <div class="bonif-label">Total de Bonifica√ß√µes</div>
          <div class="bonif-value">${totalBonif}</div>
        </div>
        <div class="bonif-item">
          <div class="bonif-label">Valor Total</div>
          <div class="bonif-value">R$ ${valorTotal.toFixed(0)}</div>
        </div>
        <div class="bonif-item">
          <div class="bonif-label">Valor M√©dio</div>
          <div class="bonif-value">R$ ${valorMedio.toFixed(0)}</div>
        </div>
        <div class="bonif-item">
          <div class="bonif-label">Com An√°lise IA</div>
          <div class="bonif-value">${comIA}</div>
        </div>
      `;
      
      const ctx = document.getElementById('bonifChart');
      if (chartsInstances.bonifChart) chartsInstances.bonifChart.destroy();
      chartsInstances.bonifChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categorias),
          datasets: [{
            data: Object.values(categorias),
            backgroundColor: [
              '#e07b3c', '#cf6a2b', '#ff9800', '#f57c00',
              '#28a745', '#218838', '#ffc107', '#ff6f00'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function renderDeptDistribution(data) {
      const relatorios = data.relatorios || {};
      const deptData = [];
      
      for (const dept in relatorios) {
        if (Array.isArray(relatorios[dept])) {
          deptData.push({
            nome: dept,
            count: relatorios[dept].length
          });
        }
      }
      
      deptData.sort((a, b) => b.count - a.count);
      const maxCount = Math.max(...deptData.map(d => d.count));
      
      const deptList = document.getElementById('deptList');
      deptList.innerHTML = deptData.map(d => `
        <div class="dept-item">
          <div class="dept-name">${d.nome}</div>
          <div class="dept-bar-container">
            <div class="dept-bar" style="width: ${(d.count / maxCount) * 100}%">
              ${d.count}
            </div>
          </div>
          <div class="dept-count">${d.count}</div>
        </div>
      `).join('');
    }

    fetch("https://iafyttcc.app.n8n.cloud/webhook/relatorios")
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log('üìä Dados recebidos:', data);
        
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        
        const bonificacoes = data.bonificacoes_com_hobbies || {};
        let temIA = false;
        for (const dept in bonificacoes) {
          if (Array.isArray(bonificacoes[dept]) && bonificacoes[dept].length > 0) {
            temIA = true;
            break;
          }
        }
        document.getElementById('badgeIA').style.display = temIA ? 'inline-block' : 'none';
        
        renderMetrics(data);
        renderScoresChart(data);
        renderCHAChart(data);
        renderRankings(data);
        renderBonificacoes(data);
        renderDeptDistribution(data);
      })
      .catch(error => {
        console.error('Erro:', error);
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('errorContainer').innerHTML = `
          <div class="error">
            ‚úï Erro ao carregar dados: ${error.message}
          </div>
        `;
      });
  </script>
</body>
</html>