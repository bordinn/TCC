<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT – Dados</title>
  <link rel="icon" href="{{ url_for('static', filename='icons/732220.png') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
    }

    header { 
      background: linear-gradient(135deg, #e07b3c 0%, #d16426 100%);
      color: white; 
      padding: 1.5rem 2rem; 
      box-shadow: 0 4px 20px rgba(224, 123, 60, 0.3);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)" /></svg>');
      opacity: 0.3;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .header-title {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .header-subtitle {
      font-size: 1rem;
      font-weight: 400;
      opacity: 0.9;
    }

    .container { 
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem; 
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      font-size: 1.1rem;
      color: #7f8c8d;
      margin-bottom: 3rem;
    }

    .status-container {
      margin-bottom: 2rem;
    }

    .loading, .error, .success {
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      text-align: center;
      border: none;
    }

    .loading {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #6c757d;
    }

    .error {
      background: linear-gradient(135deg, #fee 0%, #fdd 100%);
      color: #dc3545;
      border-left: 4px solid #dc3545;
    }

    .success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .scenario-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(224, 123, 60, 0.1);
      position: relative;
      overflow: hidden;
    }

    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #e07b3c 0%, #d16426 100%);
    }

    .scenario-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }

    .scenario-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .scenario-count {
      background: linear-gradient(135deg, #e07b3c 0%, #d16426 100%);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .scenario-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .btn {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-dashboard {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }

    .btn-dashboard:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .btn-employees {
      background: linear-gradient(135deg, #e07b3c 0%, #d16426 100%);
      color: white;
    }

    .btn-employees:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(224, 123, 60, 0.4);
    }

    .btn-bonuses {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
    }

    .btn-bonuses:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .filters-container {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: none;
    }

    .filters-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #2c3e50;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

    .filter-group {
      position: relative;
    }

    .filter-label {
      display: block;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .filter-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: white;
    }

    .filter-input:focus {
      outline: none;
      border-color: #e07b3c;
      box-shadow: 0 0 0 3px rgba(224, 123, 60, 0.1);
    }

    .data-table {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: none;
      margin: 2rem 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1rem;
      font-weight: 700;
      color: #2c3e50;
      text-align: left;
      border-bottom: 2px solid #dee2e6;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f3f4;
      font-size: 0.875rem;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .position-column, .score-column {
      background: linear-gradient(135deg, #e8f4f8 0%, #f0f9ff 100%) !important;
      font-weight: 700;
      color: #2563eb;
      text-align: center;
    }

    .dashboard-container {
      display: none;
      margin: 2rem 0;
    }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 2rem;
      color: #2c3e50;
    }

    .dashboard-stats {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }

    .dashboard-stats::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .stat-item {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 1.5rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
      font-weight: 500;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }

    .chart-container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .bonuses-container {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .bonuses-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 2rem;
      color: #2c3e50;
      text-align: center;
    }

    .podium {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .podium-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .podium-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
    }

    .podium-card.first::before { background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%); }
    .podium-card.second::before { background: linear-gradient(90deg, #c0c0c0 0%, #e5e5e5 100%); }
    .podium-card.third::before { background: linear-gradient(90deg, #cd7f32 0%, #daa520 100%); }

    .rank-badge {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 0 auto 1rem;
      color: white;
    }

    .first .rank-badge { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; }
    .second .rank-badge { background: linear-gradient(135deg, #c0c0c0 0%, #e5e5e5 100%); color: #000; }
    .third .rank-badge { background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%); }

    .employee-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .employee-info {
      color: #7f8c8d;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .bonus-options {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: left;
    }

    .bonus-options-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .bonus-option {
      margin-bottom: 1rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .bonus-type {
      font-weight: 700;
      color: #e07b3c;
      display: block;
      margin-bottom: 0.25rem;
    }

    .justification {
      background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
      border-left: 4px solid #28a745;
      padding: 1rem;
      margin-top: 1rem;
      font-style: italic;
      border-radius: 0 8px 8px 0;
      font-size: 0.875rem;
      color: #155724;
    }

    .back-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: linear-gradient(135deg, #e07b3c 0%, #d16426 100%);
      color: white;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 50px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(224, 123, 60, 0.3);
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .back-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(224, 123, 60, 0.4);
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .scenario-grid { grid-template-columns: 1fr; }
      .scenario-actions { grid-template-columns: 1fr; gap: 0.5rem; }
      .charts-grid { grid-template-columns: 1fr; }
      .podium { grid-template-columns: 1fr; }
      .filters-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-title">FYT – Find Your Talent</div>
      <div class="header-subtitle">Resultados da Análise</div>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">Relatório da Análise</h1>
    <p class="page-subtitle">Visualize os resultados completos da avaliação de talentos</p>
    
    <div id="status-container" class="status-container">
      <div class="loading">Carregando relatórios...</div>
    </div>

    <div class="scenario-grid" id="scenarioGrid"></div>

    <div id="bonificacoesContainer" class="bonuses-container"></div>

    <div id="dashboardContainer" class="dashboard-container">
      <h2 class="dashboard-title">Dashboard Analítica</h2>
      <div class="dashboard-stats">
        <div class="stats-grid" id="dashboardResumo"></div>
      </div>
      <div class="charts-grid">
        <div class="chart-container"><canvas id="chartFuncionarios"></canvas></div>
        <div class="chart-container"><canvas id="chartBonificacoes"></canvas></div>
        <div class="chart-container"><canvas id="chartScore"></canvas></div>
      </div>
    </div>

    <div class="filters-container" id="filtroContainer">
      <h3 class="filters-title">Filtros de Pesquisa</h3>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Posição</label>
          <input type="text" id="filtroPosicao" class="filter-input" placeholder="Digite a posição...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Score</label>
          <input type="text" id="filtroScore" class="filter-input" placeholder="Digite o score...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Matrícula</label>
          <input type="text" id="filtroMatricula" class="filter-input" placeholder="Digite a matrícula...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Nome</label>
          <input type="text" id="filtroNome" class="filter-input" placeholder="Digite o nome...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Departamento</label>
          <input type="text" id="filtroDepartamento" class="filter-input" placeholder="Digite o departamento...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Cargo</label>
          <input type="text" id="filtroCargo" class="filter-input" placeholder="Digite o cargo...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Data de Admissão</label>
          <input type="text" id="filtroAdmissao" class="filter-input" placeholder="Digite a data...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Avaliação Técnica</label>
          <input type="text" id="filtroTecnica" class="filter-input" placeholder="Nota técnica...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Avaliação Comportamental</label>
          <input type="text" id="filtroComportamental" class="filter-input" placeholder="Nota comportamental...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Projetos Concluídos</label>
          <input type="text" id="filtroProjetos" class="filter-input" placeholder="Qtde. projetos...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Cursos Obrigatórios</label>
          <input type="text" id="filtroObrigatorios" class="filter-input" placeholder="Cursos obrigatórios...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Cursos Adicionais</label>
          <input type="text" id="filtroAdicionais" class="filter-input" placeholder="Cursos adicionais...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Avaliação de Softskills</label>
          <input type="text" id="filtroSoftskills" class="filter-input" placeholder="Nota softskills...">
        </div>
      </div>
    </div>

    <div id="tabela-dados" class="data-table">
      <table>
        <thead id="cabecalho-tabela"></thead>
        <tbody id="corpo-tabela"></tbody>
      </table>
    </div>
  </div>

  <a href="upload.html" class="back-button">
    <i class="fas fa-arrow-left"></i>
    Voltar ao upload
  </a>

  <script>
    const tabela = document.getElementById("tabela-dados");
    const cabecalhoTabela = document.getElementById("cabecalho-tabela");
    const corpoTabela = document.getElementById("corpo-tabela");
    const scenarioGrid = document.getElementById("scenarioGrid");
    const statusContainer = document.getElementById("status-container");
    const filtroContainer = document.getElementById("filtroContainer");
    const bonificacoesContainer = document.getElementById("bonificacoesContainer");

    const filtros = {
      "Posição": document.getElementById("filtroPosicao"),
      "Score": document.getElementById("filtroScore"),
      "Matrícula": document.getElementById("filtroMatricula"),
      "Nome Completo": document.getElementById("filtroNome"),
      "Departamento": document.getElementById("filtroDepartamento"),
      "Cargo": document.getElementById("filtroCargo"),
      "Data de Admissão": document.getElementById("filtroAdmissao"),
      "Avaliação Técnica (0-10)": document.getElementById("filtroTecnica"),
      "Avaliação Comportamental (0-10)": document.getElementById("filtroComportamental"),
      "Projetos Concluídos": document.getElementById("filtroProjetos"),
      "Cursos Obrigatórios": document.getElementById("filtroObrigatorios"),
      "Cursos Adicionais": document.getElementById("filtroAdicionais"),
      "Avaliação de softskills": document.getElementById("filtroSoftskills")
    };

    let dadosCompletos = {};
    let dadosAtuais = [];

    function processarDados(dados) {
      return dados.map(item => {
        const itemProcessado = { ...item };
        if (itemProcessado.hasOwnProperty('score_ranking')) delete itemProcessado.score_ranking;
        if (itemProcessado.hasOwnProperty('posicao_no_ranking')) {
          itemProcessado['Posição'] = itemProcessado.posicao_no_ranking;
          delete itemProcessado.posicao_no_ranking;
        }
        if (itemProcessado.hasOwnProperty('score_formatado')) {
          itemProcessado['Score'] = itemProcessado.score_formatado;
          delete itemProcessado.score_formatado;
        }
        return itemProcessado;
      });
    }

    function renderizarTabela(dados) {
      cabecalhoTabela.innerHTML = "";
      corpoTabela.innerHTML = "";
      if (dados.length === 0) {
        corpoTabela.innerHTML = "<tr><td colspan='100%' style='text-align: center; color: #7f8c8d; font-style: italic;'>Nenhum dado encontrado.</td></tr>";
        return;
      }
      const headers = Object.keys(dados[0]);
      const trHead = document.createElement("tr");
      headers.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        if (header === "Posição" || header === "Score") {
          th.classList.add("position-column");
        }
        trHead.appendChild(th);
      });
      cabecalhoTabela.appendChild(trHead);
      dados.forEach(item => {
        const tr = document.createElement("tr");
        headers.forEach(key => {
          const td = document.createElement("td");
          td.textContent = item[key] || "";
          if (key === "Posição" || key === "Score") {
            td.classList.add("score-column");
          }
          tr.appendChild(td);
        });
        corpoTabela.appendChild(tr);
      });
    }

    function aplicarFiltros() {
      const filtrados = dadosAtuais.filter(item => {
        return Object.keys(filtros).every(campo => {
          const input = filtros[campo].value.toLowerCase();
          return !input || item[campo]?.toString().toLowerCase().includes(input);
        });
      });
      renderizarTabela(filtrados);
    }

    function ocultarTodosConteudos() {
      tabela.style.display = 'none';
      filtroContainer.style.display = 'none';
      bonificacoesContainer.style.display = 'none';
      document.getElementById('dashboardContainer').style.display = 'none';
    }

    function prepararTabela(dados, nomeCenario) {
      ocultarTodosConteudos();
      dadosAtuais = processarDados(dados);
      Object.values(filtros).forEach(input => {
        input.value = '';
        input.removeEventListener("input", aplicarFiltros);
        input.addEventListener("input", aplicarFiltros);
      });
      tabela.style.display = 'block';
      filtroContainer.style.display = 'block';
      renderizarTabela(dadosAtuais);
    }

    function mostrarBonificacoes(bonificacoes, nomeCenario) {
      ocultarTodosConteudos();
      bonificacoesContainer.style.display = 'block';

      let html = `<h3 class="bonuses-title">Top 3 Funcionários - ${nomeCenario}</h3>`;
      if (!bonificacoes || bonificacoes.length === 0) {
        html += '<p style="text-align: center; color: #7f8c8d; font-style: italic;">Nenhuma bonificação disponível para este cenário.</p>';
      } else {
        html += '<div class="podium">';

        bonificacoes.forEach((bonus, index) => {
          const funcionario = (dadosCompletos.relatorios[nomeCenario] || [])
            .find(f => f["Nome Completo"] === bonus.nome_completo || f["Matrícula"] === bonus.matricula);

          const score = funcionario
            ? (funcionario["Score"] || funcionario.score_formatado || funcionario.score || '0.00')
            : '0.00';

          const posicaoClass = index === 0 ? 'first' : index === 1 ? 'second' : 'third';
          const posicao = index + 1;
          
          html += `
            <div class="podium-card ${posicaoClass}">
              <div class="rank-badge">${posicao}°</div>
              <div class="employee-name">${bonus.nome_completo || 'Nome não informado'}</div>
              <div class="employee-info">
                Score: ${score}<br>
                ${bonus.departamento || 'Departamento não informado'}
              </div>
              <div class="bonus-options">
                <h4 class="bonus-options-title">Opções de Bonificação</h4>
                <div class="bonus-option">
                  <span class="bonus-type">Premiação Material:</span>
                  ${bonus.opcao_item || 'Não definido'}
                </div>
                <div class="bonus-option">
                  <span class="bonus-type">Experiência de Viagem:</span>
                  ${bonus.opcao_viagem || 'Não definido'}
                </div>
                <div class="bonus-option">
                  <span class="bonus-type">Incentivo Financeiro:</span>
                  ${bonus.opcao_bonus_salarial || 'Não definido'}
                </div>
                <div class="justification">${bonus.justificativa || 'Justificativa não informada'}</div>
              </div>
            </div>`;
        });

        html += '</div>';
      }
      bonificacoesContainer.innerHTML = html;
    }

    function criarCardCenario(cenario, dados, bonificacoes) {
      const card = document.createElement('div');
      card.className = 'scenario-card';
      
      card.innerHTML = `
        <div class="scenario-header">
          <div class="scenario-title">${cenario}</div>
          <div class="scenario-count">${dados.length} registros</div>
        </div>
        <div class="scenario-actions">
          <button class="btn btn-dashboard" onclick="mostrarDashboard('${cenario}', ${JSON.stringify(dados).replace(/"/g, '&quot;')}, ${JSON.stringify(bonificacoes).replace(/"/g, '&quot;')})">
            Dashboard
          </button>
          <button class="btn btn-employees" onclick="prepararTabela(${JSON.stringify(dados).replace(/"/g, '&quot;')}, '${cenario}')">
            Funcionários
          </button>
          <button class="btn btn-bonuses" onclick="mostrarBonificacoes(${JSON.stringify(bonificacoes).replace(/"/g, '&quot;')}, '${cenario}')">
            Bonificações
          </button>
        </div>
      `;
      
      return card;
    }

    fetch("https://iafyt.app.n8n.cloud/webhook/relatorios")
      .then(res => { 
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`); 
        return res.json(); 
      })
      .then(data => {
        statusContainer.innerHTML = '';
        dadosCompletos = data;
        const relatorios = data.relatorios || {};
        const bonificacoes = data.bonificacoes || {};
        let dadosPresentes = false;
        
        for (const cenario in relatorios) {
          const dados = relatorios[cenario];
          if (Array.isArray(dados) && dados.length > 0) {
            dadosPresentes = true;
            const bonificacoesCenario = bonificacoes[cenario] || [];
            const card = criarCardCenario(cenario, dados, bonificacoesCenario);
            scenarioGrid.appendChild(card);
          }
        }
        
        if (!dadosPresentes) {
          statusContainer.innerHTML = '<div class="error">Nenhum cenário retornou dados. Verifique se o arquivo foi processado corretamente.</div>';
        } else {
          statusContainer.innerHTML = '<div class="success">Relatórios carregados com sucesso!</div>';
        }
      })
      .catch(error => {
        console.error('Erro ao carregar relatórios:', error);
        statusContainer.innerHTML = `<div class="error">Erro ao carregar os relatórios: ${error.message}</div>`;
      });

    // Dashboard Logic
    const dashboardContainer = document.getElementById("dashboardContainer");
    const dashboardResumo = document.getElementById("dashboardResumo");

    const charts = { chartFuncionarios: null, chartBonificacoes: null, chartScore: null };
    function safeDestroy(id) { 
      if (charts[id]) { 
        charts[id].destroy(); 
        charts[id] = null; 
      } 
    }

    function toNumberScore(v) {
      if (v === undefined || v === null) return NaN;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        let s = v.replace('%', '').trim();
        
        if (s.includes(',')) {
          if (s.includes('.') && s.lastIndexOf('.') < s.lastIndexOf(',')) {
            s = s.replace(/\./g, '');
          }
          s = s.replace(',', '.');
        } else if (s.includes('.')) {
          const pontos = s.split('.');
          if (pontos.length > 2 || (pontos.length === 2 && pontos[1].length > 2)) {
            s = s.replace(/\./g, '');
          }
        }
        
        const n = parseFloat(s);
        return isNaN(n) ? NaN : n;
      }
      return NaN;
    }

    function estatisticas(arr) {
      const a = arr.filter(x => Number.isFinite(x)).sort((x,y)=>x-y);
      const n = a.length;
      const media = n ? a.reduce((s,v)=>s+v,0)/n : 0;
      const mediana = n ? (n%2? a[(n-1)/2] : (a[n/2-1]+a[n/2])/2) : 0;
      const min = n ? a[0] : 0;
      const max = n ? a[n-1] : 0;
      const vari = n ? a.reduce((s,v)=>s+(v-media)**2,0)/n : 0;
      const desvio = Math.sqrt(vari);
      return { n, media, mediana, min, max, desvio };
    }

    function binScores(values, bins = 10) {
      const arr = values.filter(Number.isFinite);
      if (!arr.length) return { labels: [], counts: [] };
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const step = (max - min) / bins || 1;
      const counts = new Array(bins).fill(0);
      const labels = [];
      for (let i=0;i<bins;i++) {
        const a = min + i*step;
        const b = i === bins-1 ? max : min + (i+1)*step;
        labels.push(`${a.toFixed(1)}–${b.toFixed(1)}`);
      }
      arr.forEach(v => {
        let idx = Math.floor((v - min) / step);
        if (idx >= bins) idx = bins-1;
        if (idx < 0) idx = 0;
        counts[idx]++;
      });
      return { labels, counts };
    }

    function mostrarDashboard(nomeCenario, dados, bonificacoes) {
      ocultarTodosConteudos();
      dashboardContainer.style.display = "block";

      const dadosProc = processarDados(dados);

      const scores = dadosProc.map(f => toNumberScore(f["Score"]))
                              .filter(Number.isFinite);
      const { n, media, mediana, max, desvio } = estatisticas(scores);

      const depsTop = new Set((bonificacoes || []).map(b => (b.departamento || 'Não informado')));

      dashboardResumo.innerHTML = `
        <div class="stat-item">
          <div class="stat-number">${nomeCenario}</div>
          <div class="stat-label">Cenário</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${dadosProc.length}</div>
          <div class="stat-label">Funcionários</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${media.toFixed(2)}</div>
          <div class="stat-label">Média de Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${mediana.toFixed(2)}</div>
          <div class="stat-label">Mediana do Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${max.toFixed(2)}</div>
          <div class="stat-label">Maior Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${desvio.toFixed(2)}</div>
          <div class="stat-label">Desvio Padrão</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${depsTop.size}</div>
          <div class="stat-label">Departamentos no Top 3</div>
        </div>
      `;

      // Chart 1: Média de Score por Departamento
      const mediasPorDepMap = new Map();
      dadosProc.forEach(f => {
        const dep = f["Departamento"] || f["departamento"] || "Não informado";
        const sc = toNumberScore(f["Score"]);
        if (!Number.isFinite(sc)) return;
        if (!mediasPorDepMap.has(dep)) mediasPorDepMap.set(dep, { soma: 0, qtd: 0 });
        const obj = mediasPorDepMap.get(dep);
        obj.soma += sc; obj.qtd += 1;
      });
      const depLabels = Array.from(mediasPorDepMap.keys());
      const depMedias = depLabels.map(d => (mediasPorDepMap.get(d).soma / mediasPorDepMap.get(d).qtd));

      safeDestroy('chartFuncionarios');
      charts.chartFuncionarios = new Chart(document.getElementById("chartFuncionarios"), {
        type: "bar",
        data: {
          labels: depLabels,
          datasets: [{
            label: "Média de Score por Departamento",
            data: depMedias,
            backgroundColor: "rgba(224, 123, 60, 0.8)",
            borderColor: "rgba(224, 123, 60, 1)",
            borderWidth: 2
          }]
        },
        options: { 
          responsive: true, 
          plugins: { 
            legend: { display: false },
            title: { display: true, text: 'Média de Score por Departamento' }
          }, 
          scales: { y: { beginAtZero: true } } 
        }
      });

      // Chart 2: Top 10 Scores
      const top = dadosProc
        .map(f => ({
          nome: f["Nome Completo"] || f["nome_completo"] || f["Matrícula"] || "—",
          dep: f["Departamento"] || f["departamento"] || "Não informado",
          score: toNumberScore(f["Score"]) || 0
        }))
        .sort((a,b)=>b.score-a.score)
        .slice(0, 10);

      safeDestroy('chartBonificacoes');
      charts.chartBonificacoes = new Chart(document.getElementById("chartBonificacoes"), {
        type: "bar",
        data: {
          labels: top.map(t => `${t.nome.split(' ')[0]} ${t.nome.split(' ')[1] || ''}`),
          datasets: [{
            label: "Top 10 Scores",
            data: top.map(t => t.score),
            backgroundColor: "rgba(39, 174, 96, 0.8)",
            borderColor: "rgba(39, 174, 96, 1)",
            borderWidth: 2
          }]
        },
        options: { 
          indexAxis: 'y', 
          responsive: true, 
          plugins: { 
            legend: { display: false },
            title: { display: true, text: 'Top 10 Funcionários por Score' }
          }, 
          scales: { x: { beginAtZero: true } } 
        }
      });

      // Chart 3: Distribuição de Scores
      const { labels: binLabels, counts } = binScores(scores, 10);
      safeDestroy('chartScore');
      charts.chartScore = new Chart(document.getElementById("chartScore"), {
        type: "bar",
        data: { 
          labels: binLabels, 
          datasets: [{ 
            label: "Distribuição de Scores", 
            data: counts, 
            backgroundColor: "rgba(52, 152, 219, 0.8)",
            borderColor: "rgba(52, 152, 219, 1)",
            borderWidth: 2
          }] 
        },
        options: { 
          responsive: true, 
          plugins: { 
            legend: { display: false },
            title: { display: true, text: 'Distribuição de Scores' }
          } 
        }
      });
    }

    // Make functions global for onclick handlers
    window.mostrarDashboard = mostrarDashboard;
    window.prepararTabela = prepararTabela;
    window.mostrarBonificacoes = mostrarBonificacoes;
  </script>
</body>
</html>