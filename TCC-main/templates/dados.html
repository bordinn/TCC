<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT – Dados</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/732220.png') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f8f9fa; }
    header { background-color: #e07b3c; color: white; padding: 15px 20px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; }
    .container { padding: 20px; }
    h2 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background-color: #f1f1f1; font-weight: 600; color: #333; }
    th:nth-child(1), td:nth-child(1) { background-color: #e8f4f8; font-weight: bold; text-align: center; color: #2563eb; }
    th:nth-child(2), td:nth-child(2) { background-color: #f0f9ff; font-weight: bold; text-align: center; color: #1d4ed8; }
    tr:hover { background-color: #f9f9f9; }
    .filtro-container { margin: 30px 0 20px 0; background-color: #ffffff; padding: 25px; border-radius: 10px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.03); }
    .filtro-container h3 { margin-bottom: 20px; color: #333; }
    .filtros-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
    .filtro-box { display: flex; flex-direction: column; position: relative; }
    .filtro-box button { padding: 10px 14px; background-color: #f1f1f1; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; text-align: left; cursor: pointer; transition: background-color 0.2s; }
    .filtro-box button:hover { background-color: #e6e6e6; }
    .filtro-input { margin-top: 8px; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; display: none; }
    .cenario-grupo { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 14px 18px; margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02); }
    .cenario-titulo { font-weight: 600; font-size: 16px; color: #333; }
    .cenario-grupo button { padding: 8px 14px; background-color: #e07b3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; margin-left: 8px; }
    .cenario-grupo button:hover { background-color: #cf6a2b; }
    .cenario-botoes { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-bonificacoes { background-color: #28a745 !important; }
    .btn-bonificacoes:hover { background-color: #218838 !important; }
    .btn-departamentos { background-color: #6f42c1 !important; }
    .btn-departamentos:hover { background-color: #5a32a3 !important; }
    .bonificacoes-container { background-color: #fff; border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
    .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
    .tab-button { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: #666; }
    .tab-button:hover { color: #e07b3c; }
    .tab-button.active { color: #e07b3c; border-bottom-color: #e07b3c; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .podium-container { display: flex; justify-content: space-around; gap: 20px; margin-top: 20px; }
    .posicao-card { flex: 1; background: #ffffff; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid; }
    .posicao-card.primeiro { border-top-color: #ffd700; }
    .posicao-card.segundo { border-top-color: #c0c0c0; }
    .posicao-card.terceiro { border-top-color: #cd7f32; }
    .medalha { font-size: 2.5em; margin-bottom: 10px; }
    .funcionario-nome { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 8px; }
    .funcionario-info { color: #666; font-size: 0.9em; margin-bottom: 15px; }
    .bonificacao-opcoes { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: left; }
    .bonificacao-opcoes h4 { margin: 0 0 12px 0; color: #333; font-size: 0.95em; }
    .opcao-linha { margin-bottom: 8px; font-size: 0.85em; line-height: 1.4; }
    .opcao-tipo { font-weight: 600; color: #e07b3c; }
    .justificativa { background-color: #e8f5e8; border-left: 4px solid #28a745; padding: 10px; margin-top: 12px; font-style: italic; font-size: 0.85em; border-radius: 0 6px 6px 0; }
    .departamento-section { margin-bottom: 40px; }
    .departamento-header { background: #e07b3c; color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 0; }
    .departamento-content { background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; border: 2px solid #667eea; border-top: none; }
    .loading { text-align: center; color: #6b7280; font-style: italic; }
    .error { color: #dc2626; background-color: #fee2e2; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .success { color: #15803d; background-color: #d1fae5; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .voltar-botao { background-color: #e07b3c; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }
    .resumo-bonificacoes { background: #ffffff; color: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #e0e0e0; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .resumo-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 15px; }
    .stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
    .stat-number { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
    .stat-label { font-size: 0.9em; opacity: 0.7; }
    .metodo-badge { display: inline-block; background: #e07b3c; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; margin-left: 10px; }
    .departamentos-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }
    @media (max-width: 768px) { 
      .podium-container { flex-direction: column; } 
      .cenario-botoes { flex-direction: column; }
      .tabs-container { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <header>
    <div>FYT – Find Your Talent</div>
    <div>Resultados da Análise <span class="metodo-badge">Método CHA</span></div>
  </header>

  <div class="container">
    <h2>Relatório da Análise</h2>
    <div id="status-container"><div class="loading">Carregando relatórios...</div></div>

    <div class="botoes-relatorios" id="botoesRelatorios"></div>

    <div id="bonificacoesContainer" class="bonificacoes-container"></div>

    <div id="dashboardContainer" style="display:none; margin-top:20px;">
      <h2>Dashboard Analítica</h2>
      <div class="resumo-bonificacoes">
        <div class="resumo-stats" id="dashboardResumo"></div>
      </div>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:20px;">
        <div><canvas id="chartFuncionarios"></canvas></div>
        <div><canvas id="chartBonificacoes"></canvas></div>
        <div><canvas id="chartScore"></canvas></div>
      </div>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:20px; margin-top:30px;">
        <div><canvas id="chartScoreRange"></canvas></div>
        <div><canvas id="chartTempo"></canvas></div>
        <div><canvas id="chartCompetencias"></canvas></div>
      </div>
    </div>

    <div class="filtro-container" id="filtroContainer" style="display: none;">
      <h3>Filtros</h3>
      <div class="filtros-grid">
        <div class="filtro-box"><button onclick="toggleInput('filtroPosicao')">Posição</button><input type="text" id="filtroPosicao" class="filtro-input" placeholder="Digite a posição..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroScore')">Score</button><input type="text" id="filtroScore" class="filtro-input" placeholder="Digite o score..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroMatricula')">Matrícula</button><input type="text" id="filtroMatricula" class="filtro-input" placeholder="Digite a matrícula..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroNome')">Nome</button><input type="text" id="filtroNome" class="filtro-input" placeholder="Digite o nome..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroDepartamento')">Departamento</button><input type="text" id="filtroDepartamento" class="filtro-input" placeholder="Digite o departamento..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroCargo')">Cargo</button><input type="text" id="filtroCargo" class="filtro-input" placeholder="Digite o cargo..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroAdmissao')">Admissão</button><input type="text" id="filtroAdmissao" class="filtro-input" placeholder="Digite a data..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroConceito')">Conceito (CHA)</button><input type="text" id="filtroConceito" class="filtro-input" placeholder="Nota 1-5..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroHabilidade')">Habilidade (CHA)</button><input type="text" id="filtroHabilidade" class="filtro-input" placeholder="Nota 1-5..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroAtitude')">Atitude (CHA)</button><input type="text" id="filtroAtitude" class="filtro-input" placeholder="Nota 1-5..."></div>
      </div>
    </div>

    <table id="tabela-dados" style="display: none;">
      <thead id="cabecalho-tabela"></thead>
      <tbody id="corpo-tabela"></tbody>
    </table>
  </div>

  <div style="position: fixed; bottom: 20px; right: 20px;">
    <button onclick="window.location.href = 'upload.html'" class="voltar-botao">Voltar ao upload</button>
  </div>

  <script>
    const tabela = document.getElementById("tabela-dados");
    const cabecalhoTabela = document.getElementById("cabecalho-tabela");
    const corpoTabela = document.getElementById("corpo-tabela");
    const botoesRelatorios = document.getElementById("botoesRelatorios");
    const statusContainer = document.getElementById("status-container");
    const filtroContainer = document.getElementById("filtroContainer");
    const bonificacoesContainer = document.getElementById("bonificacoesContainer");

    // FILTROS ATUALIZADOS - REMOVIDOS: Projetos, Cursos Obrigatórios, Cursos Adicionais
    const filtros = {
      "Posição": document.getElementById("filtroPosicao"),
      "Score": document.getElementById("filtroScore"),
      "Matrícula": document.getElementById("filtroMatricula"),
      "Nome Completo": document.getElementById("filtroNome"),
      "Departamento": document.getElementById("filtroDepartamento"),
      "Cargo": document.getElementById("filtroCargo"),
      "Data de Admissão": document.getElementById("filtroAdmissao"),
      "Conceito (1-5 Likert)": document.getElementById("filtroConceito"),
      "Habilidade (1-5 Likert)": document.getElementById("filtroHabilidade"),
      "Atitude (1-5 Likert)": document.getElementById("filtroAtitude")
    };

    let dadosCompletos = {};

    function toggleInput(id) {
      const input = document.getElementById(id);
      input.style.display = input.style.display === 'block' ? 'none' : 'block';
    }

    let dadosAtuais = [];

    function processarDados(dados) {
      return dados.map(item => {
        const itemProcessado = { ...item };
        // Remove campos obsoletos
        if (itemProcessado.hasOwnProperty('score_ranking')) delete itemProcessado.score_ranking;
        if (itemProcessado.hasOwnProperty('Projetos Concluídos')) delete itemProcessado['Projetos Concluídos'];
        if (itemProcessado.hasOwnProperty('Cursos Obrigatórios')) delete itemProcessado['Cursos Obrigatórios'];
        if (itemProcessado.hasOwnProperty('Cursos Adicionais')) delete itemProcessado['Cursos Adicionais'];
        
        if (itemProcessado.hasOwnProperty('posicao_no_ranking')) {
          itemProcessado['Posição'] = itemProcessado.posicao_no_ranking;
          delete itemProcessado.posicao_no_ranking;
        }
        if (itemProcessado.hasOwnProperty('score_formatado')) {
          itemProcessado['Score'] = itemProcessado.score_formatado;
          delete itemProcessado.score_formatado;
        }
        return itemProcessado;
      });
    }

    function renderizarTabela(dados) {
      cabecalhoTabela.innerHTML = "";
      corpoTabela.innerHTML = "";
      if (dados.length === 0) {
        corpoTabela.innerHTML = "<tr><td colspan='100%'>Nenhum dado encontrado.</td></tr>";
        return;
      }
      const headers = Object.keys(dados[0]);
      const trHead = document.createElement("tr");
      headers.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        trHead.appendChild(th);
      });
      cabecalhoTabela.appendChild(trHead);
      dados.forEach(item => {
        const tr = document.createElement("tr");
        headers.forEach(key => {
          const td = document.createElement("td");
          td.textContent = item[key] || "";
          tr.appendChild(td);
        });
        corpoTabela.appendChild(tr);
      });
    }

    function aplicarFiltros() {
      const filtrados = dadosAtuais.filter(item => {
        return Object.keys(filtros).every(campo => {
          const input = filtros[campo].value.toLowerCase();
          return !input || item[campo]?.toString().toLowerCase().includes(input);
        });
      });
      renderizarTabela(filtrados);
    }

    function ocultarTodosConteudos() {
      tabela.style.display = 'none';
      filtroContainer.style.display = 'none';
      bonificacoesContainer.style.display = 'none';
      document.getElementById('dashboardContainer').style.display = 'none';
    }

    function prepararTabela(dados, nomeCenario) {
      ocultarTodosConteudos();
      dadosAtuais = processarDados(dados);
      Object.values(filtros).forEach(input => {
        input.value = '';
        input.removeEventListener("input", aplicarFiltros);
        input.addEventListener("input", aplicarFiltros);
      });
      tabela.style.display = 'table';
      filtroContainer.style.display = 'block';
      const titulo = document.querySelector('h2');
      titulo.textContent = `Relatório da Análise – ${nomeCenario}`;
      renderizarTabela(dadosAtuais);
    }

    function mostrarBonificacoes(bonificacoesGeral, bonificacoesDept, nomeCenario) {
      ocultarTodosConteudos();
      bonificacoesContainer.style.display = 'block';
      const titulo = document.querySelector('h2');
      titulo.textContent = `Bonificações – ${nomeCenario}`;

      let html = `<h3>Bonificações - ${nomeCenario}</h3>`;
      
      html += '<div class="tabs-container">';
      html += '<button class="tab-button active" onclick="switchTab(\'tab-geral\')">Top 3 Geral</button>';
      html += '<button class="tab-button" onclick="switchTab(\'tab-departamentos\')">Top 3 por Departamento</button>';
      html += '</div>';

      // TAB GERAL
      html += '<div id="tab-geral" class="tab-content active">';
      if (!bonificacoesGeral || bonificacoesGeral.length === 0) {
        html += '<p style="text-align: center; color: #666;">Nenhuma bonificação geral disponível.</p>';
      } else {
        html += '<div class="podium-container">';
        bonificacoesGeral.slice(0, 3).forEach((bonus, index) => {
          const funcionario = (dadosCompletos.relatorios[nomeCenario] || [])
            .find(f => f["Nome Completo"] === bonus.nome_completo || f["Matrícula"] === bonus.matricula);
          const score = funcionario ? (funcionario["Score"] || funcionario.score_formatado || '0.00') : '0.00';
          const posicaoClass = index === 0 ? 'primeiro' : index === 1 ? 'segundo' : 'terceiro';
          const posicaoTexto = index === 0 ? '1º Lugar' : index === 1 ? '2º Lugar' : '3º Lugar';
          
          html += `
            <div class="posicao-card ${posicaoClass}">
              <div class="medalha">${posicaoTexto}</div>
              <div class="funcionario-nome">${bonus.nome_completo || 'Nome não informado'}</div>
              <div class="funcionario-info">
                Score: ${score}<br>
                ${bonus.departamento || 'Departamento não informado'}
              </div>
              <div class="bonificacao-opcoes">
                <h4>Opções de Bonificação</h4>
                <div class="opcao-linha"><span class="opcao-tipo">Item:</span><br>${bonus.opcao_item || 'Não definido'}</div>
                <div class="opcao-linha"><span class="opcao-tipo">Viagem:</span><br>${bonus.opcao_viagem || 'Não definido'}</div>
                <div class="opcao-linha"><span class="opcao-tipo">Bônus:</span><br>${bonus.opcao_bonus_salarial || 'Não definido'}</div>
                <div class="justificativa">${bonus.justificativa || 'Justificativa não informada'}</div>
              </div>
            </div>`;
        });
        html += '</div>';
      }
      html += '</div>';

      // TAB DEPARTAMENTOS
      html += '<div id="tab-departamentos" class="tab-content">';
      if (!bonificacoesDept || bonificacoesDept.length === 0) {
        html += '<p style="text-align: center; color: #666;">Nenhuma bonificação por departamento disponível.</p>';
      } else {
        const departamentos = [...new Set(bonificacoesDept.map(b => b.departamento))];
        
        html += '<div class="departamentos-grid">';
        departamentos.forEach(dept => {
          const bonusDept = bonificacoesDept.filter(b => b.departamento === dept).slice(0, 3);
          
          html += '<div class="departamento-section">';
          html += `<div class="departamento-header">${dept}</div>`;
          html += '<div class="departamento-content">';
          
          bonusDept.forEach((bonus, idx) => {
            const funcionario = (dadosCompletos.relatorios[nomeCenario] || [])
              .find(f => f["Nome Completo"] === bonus.nome_completo || f["Matrícula"] === bonus.matricula);
            const score = funcionario ? (funcionario["Score"] || funcionario.score_formatado || '0.00') : '0.00';
            const medalha = idx === 0 ? '1º' : idx === 1 ? '2º' : '3º';
            
            html += `
              <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ${idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : '#cd7f32'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="font-weight: bold; font-size: 1.1em;">${medalha} - ${bonus.nome_completo}</div>
                  <div style="background: #e07b3c; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">Score: ${score}</div>
                </div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                  Posição no Dept: ${bonus.posicao_departamento}º | Posição Geral: ${bonus.posicao_geral}º
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 0.85em;">
                  <div style="margin-bottom: 6px;"><strong>Item:</strong> ${bonus.opcao_item || 'Não definido'}</div>
                  <div style="margin-bottom: 6px;"><strong>Viagem:</strong> ${bonus.opcao_viagem || 'Não definido'}</div>
                  <div><strong>Bônus:</strong> ${bonus.opcao_bonus_salarial || 'Não definido'}</div>
                </div>
              </div>`;
          });
          
          html += '</div></div>';
        });
        html += '</div>';
      }
      html += '</div>';

      bonificacoesContainer.innerHTML = html;
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function criarGrupoCenario(cenario, dados, bonificacoesGeral, bonificacoesDept) {
      const grupo = document.createElement('div');
      grupo.className = 'cenario-grupo';
      const titulo = document.createElement('div');
      titulo.className = 'cenario-titulo';
      
      const totalBonif = (bonificacoesGeral?.length || 0) + (bonificacoesDept?.length || 0);
      titulo.textContent = `${cenario} (${dados.length} funcionários | ${totalBonif} bonificações)`;
      
      const botoes = document.createElement('div');
      botoes.className = 'cenario-botoes';
      
      const btnDashboard = document.createElement('button');
      btnDashboard.textContent = `Dashboard`;
      btnDashboard.onclick = () => mostrarDashboard(cenario, dados, bonificacoesGeral);
      
      const btnDados = document.createElement('button');
      btnDados.textContent = `Funcionários`;
      btnDados.onclick = () => prepararTabela(dados, cenario);
      
      const btnBonificacoes = document.createElement('button');
      btnBonificacoes.className = 'btn-bonificacoes';
      btnBonificacoes.textContent = `Bonificações`;
      btnBonificacoes.onclick = () => mostrarBonificacoes(bonificacoesGeral, bonificacoesDept, cenario);
      
      botoes.appendChild(btnDashboard);
      botoes.appendChild(btnDados);
      botoes.appendChild(btnBonificacoes);
      grupo.appendChild(titulo);
      grupo.appendChild(botoes);
      return grupo;
    }

    fetch("https://iafyt5.app.n8n.cloud/webhook/relatorios")
      .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`); return res.json(); })
      .then(data => {
        statusContainer.innerHTML = '';
        dadosCompletos = data;
        const relatorios = data.relatorios || {};
        const bonificacoes = data.bonificacoes || {};
        const bonificacoesDept = data.bonificacoes_por_departamento || {};
        
        let dadosPresentes = false;
        for (const cenario in relatorios) {
          const dados = relatorios[cenario];
          if (Array.isArray(dados) && dados.length > 0) {
            dadosPresentes = true;
            const bonifGeral = bonificacoes[cenario] || [];
            const bonifDept = bonificacoesDept[cenario] || [];
            const grupo = criarGrupoCenario(cenario, dados, bonifGeral, bonifDept);
            botoesRelatorios.appendChild(grupo);
          }
        }
        if (!dadosPresentes) {
          statusContainer.innerHTML = '<div class="error">Nenhum cenário retornou dados. Verifique se o arquivo foi processado corretamente.</div>';
        } else {
          statusContainer.innerHTML = `<div class="success">Relatórios carregados!</div>`;
        }
      })
      .catch(error => {
        console.error('Erro ao carregar relatórios:', error);
        statusContainer.innerHTML = `<div class="error">Erro ao carregar os relatórios: ${error.message}</div>`;
      });

    const dashboardContainer = document.getElementById("dashboardContainer");
    const dashboardResumo = document.getElementById("dashboardResumo");

    const charts = { chartFuncionarios: null, chartBonificacoes: null, chartScore: null, chartScoreRange: null, chartTempo: null, chartCompetencias: null };
    function safeDestroy(id) { if (charts[id]) { charts[id].destroy(); charts[id] = null; } }

    function toNumberScore(v) {
      if (v === undefined || v === null) return NaN;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        let s = v.replace('%', '').trim();
        if (s.includes(',')) {
          if (s.includes('.') && s.lastIndexOf('.') < s.lastIndexOf(',')) {
            s = s.replace(/\./g, '');
          }
          s = s.replace(',', '.');
        } else if (s.includes('.')) {
          const pontos = s.split('.');
          if (pontos.length > 2 || (pontos.length === 2 && pontos[1].length > 2)) {
            s = s.replace(/\./g, '');
          }
        }
        const n = parseFloat(s);
        return isNaN(n) ? NaN : n;
      }
      return NaN;
    }

    function estatisticas(arr) {
      const a = arr.filter(x => Number.isFinite(x)).sort((x,y)=>x-y);
      const n = a.length;
      const media = n ? a.reduce((s,v)=>s+v,0)/n : 0;
      const mediana = n ? (n%2? a[(n-1)/2] : (a[n/2-1]+a[n/2])/2) : 0;
      const min = n ? a[0] : 0;
      const max = n ? a[n-1] : 0;
      const vari = n ? a.reduce((s,v)=>s+(v-media)**2,0)/n : 0;
      const desvio = Math.sqrt(vari);
      return { n, media, mediana, min, max, desvio };
    }

    function binScores(values, bins = 10) {
      const arr = values.filter(Number.isFinite);
      if (!arr.length) return { labels: [], counts: [] };
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const step = (max - min) / bins || 1;
      const counts = new Array(bins).fill(0);
      const labels = [];
      for (let i=0;i<bins;i++) {
        const a = min + i*step;
        const b = i === bins-1 ? max : min + (i+1)*step;
        labels.push(`${a.toFixed(1)}–${b.toFixed(1)}`);
      }
      arr.forEach(v => {
        let idx = Math.floor((v - min) / step);
        if (idx >= bins) idx = bins-1;
        if (idx < 0) idx = 0;
        counts[idx]++;
      });
      return { labels, counts };
    }

    function mostrarDashboard(nomeCenario, dados, bonificacoes) {
      ocultarTodosConteudos();
      dashboardContainer.style.display = "block";

      const dadosProc = processarDados(dados);

      const scores = dadosProc.map(f => toNumberScore(f["Score"])).filter(Number.isFinite);
      const { n, media, mediana, max, desvio } = estatisticas(scores);

      const depsTop = new Set((bonificacoes || []).map(b => (b.departamento || 'Não informado')));

      dashboardResumo.innerHTML = `
        <div class="stat-item">
          <div class="stat-number">${nomeCenario}</div>
          <div class="stat-label">Cenário</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${dadosProc.length}</div>
          <div class="stat-label">Funcionários</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${media.toFixed(2)}</div>
          <div class="stat-label">Média de Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${mediana.toFixed(2)}</div>
          <div class="stat-label">Mediana do Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${max.toFixed(2)}</div>
          <div class="stat-label">Maior Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${desvio.toFixed(2)}</div>
          <div class="stat-label">Desvio Padrão</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${depsTop.size}</div>
          <div class="stat-label">Departamentos no Top 3</div>
        </div>
      `;

      const mediasPorDepMap = new Map();
      dadosProc.forEach(f => {
        const dep = f["Departamento"] || f["departamento"] || "Não informado";
        const sc = toNumberScore(f["Score"]);
        if (!Number.isFinite(sc)) return;
        if (!mediasPorDepMap.has(dep)) mediasPorDepMap.set(dep, { soma: 0, qtd: 0 });
        const obj = mediasPorDepMap.get(dep);
        obj.soma += sc; obj.qtd += 1;
      });
      const depLabels = Array.from(mediasPorDepMap.keys());
      const depMedias = depLabels.map(d => (mediasPorDepMap.get(d).soma / mediasPorDepMap.get(d).qtd));

      safeDestroy('chartFuncionarios');
      charts.chartFuncionarios = new Chart(document.getElementById("chartFuncionarios"), {
        type: "bar",
        data: {
          labels: depLabels,
          datasets: [{
            label: "Média de Score por Departamento",
            data: depMedias,
            backgroundColor: "#e07b3c"
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 5 } } }
      });

      const top = dadosProc
        .map(f => ({
          nome: f["Nome Completo"] || f["nome_completo"] || f["Matrícula"] || "—",
          dep: f["Departamento"] || f["departamento"] || "Não informado",
          score: toNumberScore(f["Score"]) || 0
        }))
        .sort((a,b)=>b.score-a.score)
        .slice(0, 10);

      safeDestroy('chartBonificacoes');
      charts.chartBonificacoes = new Chart(document.getElementById("chartBonificacoes"), {
        type: "bar",
        data: {
          labels: top.map(t => `${t.nome} (${t.dep})`),
          datasets: [{
            label: "Top 10 Scores",
            data: top.map(t => t.score),
            backgroundColor: "#4caf50"
          }]
        },
        options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 5 } } }
      });

      const { labels: binLabels, counts } = binScores(scores, 10);
      safeDestroy('chartScore');
      charts.chartScore = new Chart(document.getElementById("chartScore"), {
        type: "bar",
        data: { labels: binLabels, datasets: [{ label: "Distribuição de Scores", data: counts, backgroundColor: "#2196f3" }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      const variabilidadeData = depLabels.map(dep => {
        const scoresNoDep = dadosProc
          .filter(f => (f["Departamento"] || f["departamento"] || "Não informado") === dep)
          .map(f => toNumberScore(f["Score"]))
          .filter(Number.isFinite)
          .sort((a,b)=>a-b);
        
        if (!scoresNoDep.length) return { 
          percentil10: 0, percentil25: 0, percentil75: 0, percentil90: 0,
          amplitude: 0, coefVariacao: 0 
        };
        
        const n = scoresNoDep.length;
        const media = scoresNoDep.reduce((a,b)=>a+b,0)/n;
        
        const p10 = scoresNoDep[Math.floor(n * 0.1)] || scoresNoDep[0];
        const p25 = scoresNoDep[Math.floor(n * 0.25)] || scoresNoDep[0];
        const p75 = scoresNoDep[Math.floor(n * 0.75)] || scoresNoDep[n-1];
        const p90 = scoresNoDep[Math.floor(n * 0.9)] || scoresNoDep[n-1];
        
        const amplitude = p75 - p25;
        const desvio = Math.sqrt(scoresNoDep.reduce((s,v)=>s+(v-media)**2,0)/n);
        const coefVariacao = media > 0 ? (desvio / media) * 100 : 0;
        
        return { percentil10: p10, percentil25: p25, percentil75: p75, percentil90: p90, amplitude, coefVariacao };
      });

      safeDestroy('chartScoreRange');
      charts.chartScoreRange = new Chart(document.getElementById("chartScoreRange"), {
        type: "bar",
        data: {
          labels: depLabels,
          datasets: [
            { 
              label: "10º Percentil", 
              data: variabilidadeData.map(d => d.percentil10), 
              backgroundColor: "#e3f2fd",
              borderColor: "#1976d2",
              borderWidth: 1
            },
            { 
              label: "25º Percentil", 
              data: variabilidadeData.map(d => d.percentil25), 
              backgroundColor: "#fff3e0",
              borderColor: "#f57c00",
              borderWidth: 1
            },
            { 
              label: "75º Percentil", 
              data: variabilidadeData.map(d => d.percentil75), 
              backgroundColor: "#e8f5e8",
              borderColor: "#388e3c",
              borderWidth: 1
            },
            { 
              label: "90º Percentil", 
              data: variabilidadeData.map(d => d.percentil90), 
              backgroundColor: "#fce4ec",
              borderColor: "#c2185b",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { 
            title: { display: true, text: "Variabilidade de Scores por Departamento (Percentis)" },
            tooltip: {
              callbacks: {
                afterBody: function(tooltipItems) {
                  const index = tooltipItems[0].dataIndex;
                  const dados = variabilidadeData[index];
                  return [
                    `Amplitude IQR: ${dados.amplitude.toFixed(2)}`,
                    `Coef. Variação: ${dados.coefVariacao.toFixed(1)}%`
                  ];
                }
              }
            }
          },
          scales: { 
            y: { beginAtZero: true, max: 5 },
            x: { ticks: { maxRotation: 45 } }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });

      const tempoData = dadosProc.map(f => {
        const admissao = f["Data de Admissão"] || f["data_admissao"] || "";
        let anosNaCasa = 0;
        
        if (admissao) {
          try {
            let dataAdmissao;
            if (admissao.includes('/')) {
              const partes = admissao.split('/');
              if (partes.length === 3) {
                const d = parseInt(partes[0]);
                const m = parseInt(partes[1]);
                const y = parseInt(partes[2]);
                dataAdmissao = new Date(y, m-1, d);
              }
            } else if (admissao.includes('-')) {
              dataAdmissao = new Date(admissao);
            }
            
            if (dataAdmissao && !isNaN(dataAdmissao.getTime())) {
              const agora = new Date();
              anosNaCasa = (agora - dataAdmissao) / (1000 * 60 * 60 * 24 * 365.25);
              anosNaCasa = Math.max(0, anosNaCasa);
            }
          } catch (e) {
            anosNaCasa = 0;
          }
        }

        return {
          anos: anosNaCasa,
          score: toNumberScore(f["Score"]) || 0,
          nome: f["Nome Completo"] || f["Matrícula"] || "—"
        };
      }).filter(d => d.anos > 0 && Number.isFinite(d.score));

      safeDestroy('chartTempo');
      charts.chartTempo = new Chart(document.getElementById("chartTempo"), {
        type: "scatter",
        data: {
          datasets: [{
            label: "Score vs Tempo de Casa",
            data: tempoData.map(d => ({ x: d.anos, y: d.score })),
            backgroundColor: "#9c27b0",
            borderColor: "#9c27b0"
          }]
        },
        options: {
          responsive: true,
          plugins: { 
            title: { display: true, text: "Relação Score x Tempo de Casa" },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const ponto = tempoData[context.dataIndex];
                  return `${ponto.nome}: ${ponto.anos.toFixed(1)} anos, Score: ${ponto.score.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: "Anos na Empresa" } },
            y: { title: { display: true, text: "Score (1-5)" }, beginAtZero: true, max: 5 }
          }
        }
      });

      const competenciasCHA = ['Conceito', 'Habilidade', 'Atitude'];
      const mediaCompetencias = competenciasCHA.map(comp => {
        const campo = `${comp} (1-5 Likert)`;
        const valores = dadosProc
          .map(f => toNumberScore(f[campo]))
          .filter(Number.isFinite);
        
        return valores.length ? valores.reduce((a,b)=>a+b,0)/valores.length : 0;
      });

      const top3Competencias = (bonificacoes || []).slice(0, 3).map((bonus, idx) => {
        const funcionario = dadosProc.find(f => 
          f["Nome Completo"] === bonus.nome_completo || f["Matrícula"] === bonus.matricula
        );
        
        if (!funcionario) return null;
        
        return {
          label: `${idx + 1}º Lugar`,
          data: competenciasCHA.map(comp => {
            const campo = `${comp} (1-5 Likert)`;
            return toNumberScore(funcionario[campo]) || 0;
          }),
          backgroundColor: idx === 0 ? 'rgba(255, 215, 0, 0.2)' : idx === 1 ? 'rgba(192, 192, 192, 0.2)' : 'rgba(205, 127, 50, 0.2)',
          borderColor: idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : '#cd7f32',
          borderWidth: 2
        };
      }).filter(Boolean);

      safeDestroy('chartCompetencias');
      charts.chartCompetencias = new Chart(document.getElementById("chartCompetencias"), {
        type: "radar",
        data: {
          labels: competenciasCHA,
          datasets: [
            {
              label: "Média Geral",
              data: mediaCompetencias,
              backgroundColor: 'rgba(224, 123, 60, 0.2)',
              borderColor: '#e07b3c',
              borderWidth: 2
            },
            ...top3Competencias
          ]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "Método CHA: Média Geral vs Top 3" } },
          scales: {
            r: {
              beginAtZero: true,
              max: 5,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
  </script>
</body>
</html>