<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT – Dados</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/732220.png') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f8f9fa; }
    header { background-color: #e07b3c; color: white; padding: 15px 20px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; }
    .container { padding: 20px; }
    h2 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background-color: #f1f1f1; font-weight: 600; color: #333; }
    th:nth-child(1), td:nth-child(1) { background-color: #e8f4f8; font-weight: bold; text-align: center; color: #2563eb; }
    th:nth-child(2), td:nth-child(2) { background-color: #f0f9ff; font-weight: bold; text-align: center; color: #1d4ed8; }
    tr:hover { background-color: #f9f9f9; }
    .filtro-container { margin: 30px 0 20px 0; background-color: #ffffff; padding: 25px; border-radius: 10px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.03); }
    .filtro-container h3 { margin-bottom: 20px; color: #333; }
    .filtros-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
    .filtro-box { display: flex; flex-direction: column; position: relative; }
    .filtro-box button { padding: 10px 14px; background-color: #f1f1f1; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; text-align: left; cursor: pointer; transition: background-color 0.2s; }
    .filtro-box button:hover { background-color: #e6e6e6; }
    .filtro-input { margin-top: 8px; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; display: none; }
    .cenario-grupo { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 14px 18px; margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02); }
    .cenario-titulo { font-weight: 600; font-size: 16px; color: #333; }
    .cenario-grupo button { padding: 8px 14px; background-color: #e07b3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; margin-left: 8px; }
    .cenario-grupo button:hover { background-color: #cf6a2b; }
    .cenario-botoes { display: flex; gap: 8px; }
    .btn-bonificacoes { background-color: #28a745 !important; }
    .btn-bonificacoes:hover { background-color: #218838 !important; }
    .bonificacoes-container { background-color: #fff; border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
    .podium-container { display: flex; justify-content: space-around; gap: 20px; margin-top: 20px; }
    .posicao-card { flex: 1; background: #ffffff; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid; }
    .posicao-card.primeiro { border-top-color: #ffd700; }
    .posicao-card.segundo { border-top-color: #c0c0c0; }
    .posicao-card.terceiro { border-top-color: #cd7f32; }
    .medalha { font-size: 2.5em; margin-bottom: 10px; }
    .funcionario-nome { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 8px; }
    .funcionario-info { color: #666; font-size: 0.9em; margin-bottom: 15px; }
    .bonificacao-opcoes { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: left; }
    .bonificacao-opcoes h4 { margin: 0 0 12px 0; color: #333; font-size: 0.95em; }
    .opcao-linha { margin-bottom: 8px; font-size: 0.85em; line-height: 1.4; }
    .opcao-tipo { font-weight: 600; color: #e07b3c; }
    .justificativa { background-color: #e8f5e8; border-left: 4px solid #28a745; padding: 10px; margin-top: 12px; font-style: italic; font-size: 0.85em; border-radius: 0 6px 6px 0; }
    .loading { text-align: center; color: #6b7280; font-style: italic; }
    .error { color: #dc2626; background-color: #fee2e2; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .success { color: #15803d; background-color: #d1fae5; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .voltar-botao { background-color: #e07b3c; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }
    .resumo-bonificacoes { background: #ffffff; color: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #e0e0e0; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .resumo-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 15px; }
    .stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
    .stat-number { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
    .stat-label { font-size: 0.9em; opacity: 0.7; }
    @media (max-width: 768px) { .podium-container { flex-direction: column; } .cenario-botoes { flex-direction: column; } }
  </style>
</head>
<body>
  <header>
    <div>FYT – Find Your Talent</div>
    <div>Resultados da Análise</div>
  </header>

  <div class="container">
    <h2>Relatório da Análise</h2>
    <div id="status-container"><div class="loading">Carregando relatórios...</div></div>

    <div class="botoes-relatorios" id="botoesRelatorios"></div>

    <!-- Container para mostrar bonificações -->
    <div id="bonificacoesContainer" class="bonificacoes-container"></div>

    <!-- DASHBOARD -->
    <div id="dashboardContainer" style="display:none; margin-top:20px;">
      <h2>Dashboard Analítica</h2>
      <div class="resumo-bonificacoes">
        <div class="resumo-stats" id="dashboardResumo"></div>
      </div>
      <!-- Mantemos os mesmos IDs de canvas, mas com novos conteúdos: -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:20px;">
        <div><canvas id="chartFuncionarios"></canvas></div> <!-- Média de Score por Departamento -->
        <div><canvas id="chartBonificacoes"></canvas></div> <!-- Top 10 Scores -->
        <div><canvas id="chartScore"></canvas></div>         <!-- Distribuição (Histograma) de Scores -->
      </div>
    </div>

    <div class="filtro-container" id="filtroContainer" style="display: none;">
      <h3>Filtros</h3>
      <div class="filtros-grid">
        <div class="filtro-box"><button onclick="toggleInput('filtroPosicao')">Posição</button><input type="text" id="filtroPosicao" class="filtro-input" placeholder="Digite a posição..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroScore')">Score</button><input type="text" id="filtroScore" class="filtro-input" placeholder="Digite o score..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroMatricula')">Matrícula</button><input type="text" id="filtroMatricula" class="filtro-input" placeholder="Digite a matrícula..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroNome')">Nome</button><input type="text" id="filtroNome" class="filtro-input" placeholder="Digite o nome..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroDepartamento')">Departamento</button><input type="text" id="filtroDepartamento" class="filtro-input" placeholder="Digite o departamento..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroCargo')">Cargo</button><input type="text" id="filtroCargo" class="filtro-input" placeholder="Digite o cargo..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroAdmissao')">Admissão</button><input type="text" id="filtroAdmissao" class="filtro-input" placeholder="Digite a data..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroTecnica')">Técnica</button><input type="text" id="filtroTecnica" class="filtro-input" placeholder="Nota técnica..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroComportamental')">Comportamental</button><input type="text" id="filtroComportamental" class="filtro-input" placeholder="Nota comportamental..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroProjetos')">Projetos</button><input type="text" id="filtroProjetos" class="filtro-input" placeholder="Qtde. projetos..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroObrigatorios')">Obrigatórios</button><input type="text" id="filtroObrigatorios" class="filtro-input" placeholder="Cursos obrigatórios..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroAdicionais')">Adicionais</button><input type="text" id="filtroAdicionais" class="filtro-input" placeholder="Cursos adicionais..."></div>
        <div class="filtro-box"><button onclick="toggleInput('filtroSoftskills')">Softskills</button><input type="text" id="filtroSoftskills" class="filtro-input" placeholder="Nota softskills..."></div>
      </div>
    </div>

    <table id="tabela-dados" style="display: none;">
      <thead id="cabecalho-tabela"></thead>
      <tbody id="corpo-tabela"></tbody>
    </table>
  </div>

  <div style="position: fixed; bottom: 20px; right: 20px;">
    <button onclick="window.location.href = 'upload.html'" class="voltar-botao">Voltar ao upload</button>
  </div>

  <script>
    const tabela = document.getElementById("tabela-dados");
    const cabecalhoTabela = document.getElementById("cabecalho-tabela");
    const corpoTabela = document.getElementById("corpo-tabela");
    const botoesRelatorios = document.getElementById("botoesRelatorios");
    const statusContainer = document.getElementById("status-container");
    const filtroContainer = document.getElementById("filtroContainer");
    const bonificacoesContainer = document.getElementById("bonificacoesContainer");

    const filtros = {
      "Posição": document.getElementById("filtroPosicao"),
      "Score": document.getElementById("filtroScore"),
      "Matrícula": document.getElementById("filtroMatricula"),
      "Nome Completo": document.getElementById("filtroNome"),
      "Departamento": document.getElementById("filtroDepartamento"),
      "Cargo": document.getElementById("filtroCargo"),
      "Data de Admissão": document.getElementById("filtroAdmissao"),
      "Avaliação Técnica (0-10)": document.getElementById("filtroTecnica"),
      "Avaliação Comportamental (0-10)": document.getElementById("filtroComportamental"),
      "Projetos Concluídos": document.getElementById("filtroProjetos"),
      "Cursos Obrigatórios": document.getElementById("filtroObrigatorios"),
      "Cursos Adicionais": document.getElementById("filtroAdicionais"),
      "Avaliação de softskills": document.getElementById("filtroSoftskills")
    };

    let dadosCompletos = {};

    function toggleInput(id) {
      const input = document.getElementById(id);
      input.style.display = input.style.display === 'block' ? 'none' : 'block';
    }

    let dadosAtuais = [];

    function processarDados(dados) {
      return dados.map(item => {
        const itemProcessado = { ...item };
        if (itemProcessado.hasOwnProperty('score_ranking')) delete itemProcessado.score_ranking;
        if (itemProcessado.hasOwnProperty('posicao_no_ranking')) {
          itemProcessado['Posição'] = itemProcessado.posicao_no_ranking;
          delete itemProcessado.posicao_no_ranking;
        }
        if (itemProcessado.hasOwnProperty('score_formatado')) {
          itemProcessado['Score'] = itemProcessado.score_formatado;
          delete itemProcessado.score_formatado;
        }
        return itemProcessado;
      });
    }

    function renderizarTabela(dados) {
      cabecalhoTabela.innerHTML = "";
      corpoTabela.innerHTML = "";
      if (dados.length === 0) {
        corpoTabela.innerHTML = "<tr><td colspan='100%'>Nenhum dado encontrado.</td></tr>";
        return;
      }
      const headers = Object.keys(dados[0]);
      const trHead = document.createElement("tr");
      headers.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        trHead.appendChild(th);
      });
      cabecalhoTabela.appendChild(trHead);
      dados.forEach(item => {
        const tr = document.createElement("tr");
        headers.forEach(key => {
          const td = document.createElement("td");
          td.textContent = item[key] || "";
          tr.appendChild(td);
        });
        corpoTabela.appendChild(tr);
      });
    }

    function aplicarFiltros() {
      const filtrados = dadosAtuais.filter(item => {
        return Object.keys(filtros).every(campo => {
          const input = filtros[campo].value.toLowerCase();
          return !input || item[campo]?.toString().toLowerCase().includes(input);
        });
      });
      renderizarTabela(filtrados);
    }

    function ocultarTodosConteudos() {
      tabela.style.display = 'none';
      filtroContainer.style.display = 'none';
      bonificacoesContainer.style.display = 'none';
      // dashboard é controlado separadamente
    }

    function prepararTabela(dados, nomeCenario) {
      ocultarTodosConteudos();
      dadosAtuais = processarDados(dados);
      Object.values(filtros).forEach(input => {
        input.value = '';
        input.removeEventListener("input", aplicarFiltros);
        input.addEventListener("input", aplicarFiltros);
      });
      tabela.style.display = 'table';
      filtroContainer.style.display = 'block';
      const titulo = document.querySelector('h2');
      titulo.textContent = `Relatório da Análise – ${nomeCenario}`;
      renderizarTabela(dadosAtuais);
    }

    function mostrarBonificacoes(bonificacoes, nomeCenario) {
      ocultarTodosConteudos();
      bonificacoesContainer.style.display = 'block';
      const titulo = document.querySelector('h2');
      titulo.textContent = `Bonificações – ${nomeCenario}`;

      let html = `<h3>Top 3 Funcionários - ${nomeCenario}</h3>`;
      if (!bonificacoes || bonificacoes.length === 0) {
        html += '<p style="text-align: center; color: #666;">Nenhuma bonificação disponível para este cenário.</p>';
      } else {
        html += '<div class="podium-container">';

        bonificacoes.forEach((bonus, index) => {
          // procura o funcionário correspondente no relatório
          const funcionario = (dadosCompletos.relatorios[nomeCenario] || [])
            .find(f => f["Nome Completo"] === bonus.nome_completo || f["Matrícula"] === bonus.matricula);

          // pega o score certo (normalizado)
          const score = funcionario
            ? (funcionario["Score"] || funcionario.score_formatado || funcionario.score || '0.00')
            : '0.00';

          const posicaoClass = index === 0 ? 'primeiro' : index === 1 ? 'segundo' : 'terceiro';
          const posicaoTexto = index === 0 ? '1º Lugar' : index === 1 ? '2º Lugar' : '3º Lugar';
          html += `
            <div class="posicao-card ${posicaoClass}">
              <div class="medalha">${posicaoTexto}</div>
              <div class="funcionario-nome">${bonus.nome_completo || 'Nome não informado'}</div>
              <div class="funcionario-info">
                Score: ${score}<br>
                ${bonus.departamento || 'Departamento não informado'}
              </div>
              <div class="bonificacao-opcoes">
                <h4>Opções de Bonificação</h4>
                <div class="opcao-linha"><span class="opcao-tipo">Item:</span><br>${bonus.opcao_item || 'Não definido'}</div>
                <div class="opcao-linha"><span class="opcao-tipo">Viagem:</span><br>${bonus.opcao_viagem || 'Não definido'}</div>
                <div class="opcao-linha"><span class="opcao-tipo">Bônus:</span><br>${bonus.opcao_bonus_salarial || 'Não definido'}</div>
                <div class="justificativa">${bonus.justificativa || 'Justificativa não informada'}</div>
              </div>
            </div>`;
        });

        html += '</div>';
      }
      bonificacoesContainer.innerHTML = html;
    }

    function criarGrupoCenario(cenario, dados, bonificacoes) {
      const grupo = document.createElement('div');
      grupo.className = 'cenario-grupo';
      const titulo = document.createElement('div');
      titulo.className = 'cenario-titulo';
      titulo.textContent = `${cenario} (${dados.length} registros)`;
      const botoes = document.createElement('div');
      botoes.className = 'cenario-botoes';
      const btnDados = document.createElement('button');
      btnDados.textContent = `Ver Funcionários`;
      btnDados.onclick = () => prepararTabela(dados, cenario);
      const btnBonificacoes = document.createElement('button');
      btnBonificacoes.className = 'btn-bonificacoes';
      btnBonificacoes.textContent = `Ver Bonificações`;
      btnBonificacoes.onclick = () => mostrarBonificacoes(bonificacoes, cenario);
      const btnDashboard = document.createElement('button');
      btnDashboard.textContent = `Ver Dashboard`;
      btnDashboard.onclick = () => mostrarDashboard(cenario, dados, bonificacoes);
      botoes.appendChild(btnDashboard);
      botoes.appendChild(btnDados);
      botoes.appendChild(btnBonificacoes);
      grupo.appendChild(titulo);
      grupo.appendChild(botoes);
      return grupo;
    }

    fetch("https://iafyt.app.n8n.cloud/webhook/relatorios")
      .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`); return res.json(); })
      .then(data => {
        statusContainer.innerHTML = '';
        dadosCompletos = data;
        const relatorios = data.relatorios || {};
        const bonificacoes = data.bonificacoes || {};
        let dadosPresentes = false;
        for (const cenario in relatorios) {
          const dados = relatorios[cenario];
          if (Array.isArray(dados) && dados.length > 0) {
            dadosPresentes = true;
            const bonificacoesCenario = bonificacoes[cenario] || [];
            const grupo = criarGrupoCenario(cenario, dados, bonificacoesCenario);
            botoesRelatorios.appendChild(grupo);
          }
        }
        if (!dadosPresentes) {
          statusContainer.innerHTML = '<div class="error">Nenhum cenário retornou dados. Verifique se o arquivo foi processado corretamente.</div>';
        } else {
          statusContainer.innerHTML = '<div class="success">Relatórios carregados com sucesso!</div>';
        }
      })
      .catch(error => {
        console.error('Erro ao carregar relatórios:', error);
        statusContainer.innerHTML = `<div class="error">Erro ao carregar os relatórios: ${error.message}</div>`;
      });

    // ======== NOVA LÓGICA DO DASHBOARD ========
    const dashboardContainer = document.getElementById("dashboardContainer");
    const dashboardResumo = document.getElementById("dashboardResumo");

    const charts = { chartFuncionarios: null, chartBonificacoes: null, chartScore: null };
    function safeDestroy(id) { if (charts[id]) { charts[id].destroy(); charts[id] = null; } }

    function toNumberScore(v) {
      if (v === undefined || v === null) return NaN;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        // Remove % se existir
        let s = v.replace('%', '').trim();
        
        // Trata formato brasileiro (vírgula como decimal)
        // Se tem vírgula, assume que é decimal brasileiro (ex: "8,39" ou "1.234,56")
        if (s.includes(',')) {
          // Se tem ponto antes da vírgula, remove pontos (milhares)
          if (s.includes('.') && s.lastIndexOf('.') < s.lastIndexOf(',')) {
            s = s.replace(/\./g, '');
          }
          // Troca vírgula por ponto para parseFloat
          s = s.replace(',', '.');
        }
        // Se não tem vírgula mas tem ponto, verifica se é decimal ou milhares
        else if (s.includes('.')) {
          // Se tem mais de um ponto ou se o último ponto tem mais de 2 dígitos depois, são milhares
          const pontos = s.split('.');
          if (pontos.length > 2 || (pontos.length === 2 && pontos[1].length > 2)) {
            // Remove pontos (são separadores de milhares)
            s = s.replace(/\./g, '');
          }
          // Senão, mantém como está (é decimal)
        }
        
        const n = parseFloat(s);
        return isNaN(n) ? NaN : n;
      }
      return NaN;
    }

    function estatisticas(arr) {
      const a = arr.filter(x => Number.isFinite(x)).sort((x,y)=>x-y);
      const n = a.length;
      const media = n ? a.reduce((s,v)=>s+v,0)/n : 0;
      const mediana = n ? (n%2? a[(n-1)/2] : (a[n/2-1]+a[n/2])/2) : 0;
      const min = n ? a[0] : 0;
      const max = n ? a[n-1] : 0;
      const vari = n ? a.reduce((s,v)=>s+(v-media)**2,0)/n : 0;
      const desvio = Math.sqrt(vari);
      return { n, media, mediana, min, max, desvio };
    }

    function binScores(values, bins = 10) {
      const arr = values.filter(Number.isFinite);
      if (!arr.length) return { labels: [], counts: [] };
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const step = (max - min) / bins || 1;
      const counts = new Array(bins).fill(0);
      const labels = [];
      for (let i=0;i<bins;i++) {
        const a = min + i*step;
        const b = i === bins-1 ? max : min + (i+1)*step;
        labels.push(`${a.toFixed(1)}–${b.toFixed(1)}`);
      }
      arr.forEach(v => {
        let idx = Math.floor((v - min) / step);
        if (idx >= bins) idx = bins-1;
        if (idx < 0) idx = 0;
        counts[idx]++;
      });
      return { labels, counts };
    }

    function mostrarDashboard(nomeCenario, dados, bonificacoes) {
      ocultarTodosConteudos();
      dashboardContainer.style.display = "block";

      // Normaliza os dados para garantir campos "Score" e "Posição"
      const dadosProc = processarDados(dados);

      // ======== RESUMO =========
      const scores = dadosProc.map(f => toNumberScore(f["Score"]))
                              .filter(Number.isFinite);
      const { n, media, mediana, max, desvio } = estatisticas(scores);

      // diversidade de departamentos no Top 3 (informação útil para distribuição de reconhecimento)
      const depsTop = new Set((bonificacoes || []).map(b => (b.departamento || 'Não informado')));

      dashboardResumo.innerHTML = `
        <div class="stat-item">
          <div class="stat-number">${nomeCenario}</div>
          <div class="stat-label">Cenário</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${dadosProc.length}</div>
          <div class="stat-label">Funcionários</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${media.toFixed(2)}</div>
          <div class="stat-label">Média de Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${mediana.toFixed(2)}</div>
          <div class="stat-label">Mediana do Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${max.toFixed(2)}</div>
          <div class="stat-label">Maior Score</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${desvio.toFixed(2)}</div>
          <div class="stat-label">Desvio Padrão</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${depsTop.size}</div>
          <div class="stat-label">Departamentos no Top 3</div>
        </div>
      `;

      // ======== 1) MÉDIA DE SCORE POR DEPARTAMENTO =========
      const mediasPorDepMap = new Map(); // dep -> { soma, qtd }
      dadosProc.forEach(f => {
        const dep = f["Departamento"] || f["departamento"] || "Não informado";
        const sc = toNumberScore(f["Score"]);
        if (!Number.isFinite(sc)) return;
        if (!mediasPorDepMap.has(dep)) mediasPorDepMap.set(dep, { soma: 0, qtd: 0 });
        const obj = mediasPorDepMap.get(dep);
        obj.soma += sc; obj.qtd += 1;
      });
      const depLabels = Array.from(mediasPorDepMap.keys());
      const depMedias = depLabels.map(d => (mediasPorDepMap.get(d).soma / mediasPorDepMap.get(d).qtd));

      safeDestroy('chartFuncionarios');
      charts.chartFuncionarios = new Chart(document.getElementById("chartFuncionarios"), {
        type: "bar",
        data: {
          labels: depLabels,
          datasets: [{
            label: "Média de Score por Departamento",
            data: depMedias,
            backgroundColor: "#e07b3c"
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      // ======== 2) TOP 10 SCORES (gráfico horizontal) =========
      const top = dadosProc
        .map(f => ({
          nome: f["Nome Completo"] || f["nome_completo"] || f["Matrícula"] || "—",
          dep: f["Departamento"] || f["departamento"] || "Não informado",
          score: toNumberScore(f["Score"]) || 0
        }))
        .sort((a,b)=>b.score-a.score)
        .slice(0, 10);

      safeDestroy('chartBonificacoes');
      charts.chartBonificacoes = new Chart(document.getElementById("chartBonificacoes"), {
        type: "bar",
        data: {
          labels: top.map(t => `${t.nome} (${t.dep})`),
          datasets: [{
            label: "Top 10 Scores",
            data: top.map(t => t.score),
            backgroundColor: "#4caf50"
          }]
        },
        options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
      });

      // ======== 3) DISTRIBUIÇÃO DE SCORES (HISTOGRAMA) =========
      const { labels: binLabels, counts } = binScores(scores, 10);
      safeDestroy('chartScore');
      charts.chartScore = new Chart(document.getElementById("chartScore"), {
        type: "bar",
        data: { labels: binLabels, datasets: [{ label: "Distribuição de Scores", data: counts, backgroundColor: "#2196f3" }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
  </script>
</body>
</html>