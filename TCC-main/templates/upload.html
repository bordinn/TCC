<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT ‚Äì Upload</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    header {
      background-color: #e07b3c;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      max-width: 600px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    select {
      width: 100%;
      padding: 10px;
      margin: 10px 0 20px 0;
      border: 2px solid #ddd;
      font-size: 16px;
    }

    .upload-box {
      border: 3px dashed #e07b3c;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      background-color: #fff8f3;
    }

    .upload-box:hover {
      background-color: #ffe8d9;
    }

    .upload-icon {
      font-size: 60px;
      color: #e07b3c;
    }

    .format-info {
      text-align: center;
      color: #666;
      margin-top: 10px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      background-color: #e07b3c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }

    button:hover:not(:disabled) {
      background-color: #cf6a2b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      margin-top: 20px;
      display: none;
      height: 40px;
      border: 2px solid #333;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #e07b3c 0%, #cf6a2b 100%);
      text-align: center;
      line-height: 40px;
      color: white;
      font-weight: bold;
      font-size: 18px;
      transition: width 0.3s linear;
      width: 0%;
    }

    .processing-message {
      background-color: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 20px;
      margin-top: 20px;
      display: none;
      text-align: center;
    }

    .processing-message h4 {
      margin: 0 0 10px 0;
      color: #856404;
      font-size: 18px;
    }

    .processing-message p {
      margin: 5px 0;
      color: #856404;
      font-size: 15px;
    }

    .stats-summary {
      background: #e7f3ff;
      border-left: 5px solid #2196F3;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .stats-summary h4 {
      margin: 0 0 15px 0;
      color: #0d47a1;
      font-size: 18px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #bbdefb;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #1976d2;
    }

    .stat-value {
      font-weight: bold;
      color: #0d47a1;
    }

    .countdown {
      font-size: 1.5em;
      color: #e07b3c;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }

    #mensagem {
      margin-top: 20px;
      padding: 15px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div>FYT ‚Äì Find Your Talent</div>
    <div>Ol√°, Coordenador!</div>
  </header>

  <div class="container">
    <label>Selecione a sua √°rea:</label>
    <select id="areaSelect">
      <option>RH</option>
      <option>Cont√°bil</option>
      <option>Jur√≠dico</option>
      <option>TI</option>
      <option>Treinamento</option>
      <option>Compras</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">üìÑ</div>
      <div style="margin-top: 10px; font-size: 16px; color: #666;">Clique para selecionar arquivo CSV</div>
    </div>

    <div class="format-info">Formato aceito: .CSV</div>
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
    <div id="nome-arquivo" style="margin-top: 15px; font-weight: bold; color: #333;"></div>

    <button id="botaoEnviar">
      Enviar Arquivo
    </button>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="processing-message" id="processingMessage">
      <h4>Processamento em andamento</h4>
      <p>Aguarde enquanto os dados s√£o processados...</p>
      <p style="margin-top: 10px; font-style: italic;">Tempo estimado: 10 segundos</p>
    </div>

    <div class="stats-summary" id="statsSummary">
      <h4>Resumo do Processamento</h4>
      <div id="statsContent"></div>
    </div>

    <div id="mensagem"></div>
    <div id="countdown" class="countdown"></div>
  </div>

  <script>
    let arquivoSelecionado = null;

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const nomeArquivo = document.getElementById("nome-arquivo");
      const mensagem = document.getElementById("mensagem");
      mensagem.textContent = "";
      mensagem.style.backgroundColor = "";

      if (!file) {
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      const extensao = file.name.split(".").pop().toLowerCase();
      if (extensao !== "csv") {
        mensagem.textContent = "Formato inv√°lido. Envie um arquivo .CSV.";
        mensagem.style.color = "red";
        mensagem.style.backgroundColor = "#ffe6e6";
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      nomeArquivo.textContent = `Arquivo selecionado: ${file.name}`;
      arquivoSelecionado = file;
    });

    function exibirEstatisticas(resultado) {
      const statsContent = document.getElementById('statsContent');
      const statsSummary = document.getElementById('statsSummary');
      
      let html = '';
      
      if (resultado.resumo) {
        html += `
          <div class="stat-item">
            <span class="stat-label">Cen√°rios Processados:</span>
            <span class="stat-value">${resultado.resumo.total_cenarios || 0}</span>
          </div>
        `;
      }
      
      if (resultado.estatisticas_hobbies) {
        const stats = resultado.estatisticas_hobbies;
        html += `
          <div class="stat-item">
            <span class="stat-label">Total Analisado:</span>
            <span class="stat-value">${stats.total_analisados || 0} funcion√°rios</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Valor Total Sugerido:</span>
            <span class="stat-value">R$ ${(stats.valor_total_sugerido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Taxa de Sucesso:</span>
            <span class="stat-value">${stats.taxa_sucesso || '0%'}</span>
          </div>
        `;
      }
      
      if (resultado.gist_info && resultado.gist_info.url) {
        html += `
          <div class="stat-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #2196F3;">
            <span class="stat-label">GitHub Gist:</span>
            <a href="${resultado.gist_info.url}" target="_blank" style="color: #1976d2; font-weight: bold; text-decoration: underline;">Acessar Relat√≥rios</a>
          </div>
        `;
      }
      
      statsContent.innerHTML = html;
      statsSummary.style.display = 'block';
    }

    document.getElementById("botaoEnviar").addEventListener("click", async function () {
      const mensagem = document.getElementById("mensagem");
      const botao = document.getElementById("botaoEnviar");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const processingMessage = document.getElementById("processingMessage");
      const countdown = document.getElementById("countdown");
      const statsSummary = document.getElementById("statsSummary");
      
      mensagem.textContent = "";
      mensagem.style.backgroundColor = "";
      countdown.textContent = "";
      statsSummary.style.display = 'none';

      if (!arquivoSelecionado) {
        mensagem.textContent = "Nenhum arquivo foi selecionado.";
        mensagem.style.color = "red";
        mensagem.style.backgroundColor = "#ffe6e6";
        return;
      }

      // Desabilitar bot√£o
      botao.disabled = true;
      botao.textContent = "Processando...";
      
      // Mostrar UI de progresso
      progressContainer.style.display = 'block';
      processingMessage.style.display = 'block';

      // PROGRESSO SIMULADO DE 10 SEGUNDOS
      const DURACAO_TOTAL = 10000; // 10 segundos
      const INTERVALO = 100; // Atualiza a cada 100ms
      const TOTAL_UPDATES = DURACAO_TOTAL / INTERVALO;
      
      let currentUpdate = 0;

      const progressInterval = setInterval(() => {
        currentUpdate++;
        const percentComplete = (currentUpdate / TOTAL_UPDATES) * 100;
        
        // Atualizar barra
        progressBar.style.width = percentComplete + '%';
        progressBar.textContent = Math.floor(percentComplete) + '%';
        
        if (currentUpdate >= TOTAL_UPDATES) {
          clearInterval(progressInterval);
        }
      }, INTERVALO);

      try {
        const formData = new FormData();
        formData.append('file', arquivoSelecionado);
        formData.append('area', document.getElementById("areaSelect").value);

        console.log('Enviando arquivo para n8n...');
        const startTime = Date.now();

        // Fazer requisi√ß√£o
        const resposta = await fetch('https://iafyt5.app.n8n.cloud/webhook/upload-planilha', {
          method: 'POST',
          body: formData
        });

        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`Upload conclu√≠do em: ${elapsedTime}s`);

        // Aguardar os 10 segundos completos antes de processar resposta
        const tempoRestante = DURACAO_TOTAL - (Date.now() - startTime);
        if (tempoRestante > 0) {
          console.log(`Aguardando mais ${(tempoRestante/1000).toFixed(1)}s...`);
          await new Promise(resolve => setTimeout(resolve, tempoRestante));
        }

        clearInterval(progressInterval);

        progressBar.style.width = '100%';
        progressBar.textContent = '100% - Conclu√≠do!';

        // Processar resposta
        let resultado;
        try {
          resultado = await resposta.json();
          console.log('Resultado:', resultado);
        } catch (e) {
          console.warn('Resposta n√£o √© JSON, continuando...');
          resultado = { sucesso: true };
        }

        // Exibir estat√≠sticas se dispon√≠vel
        if (resultado && resultado.estatisticas_hobbies) {
          exibirEstatisticas(resultado);
        }

        // Mensagem de sucesso
        mensagem.style.color = 'green';
        mensagem.style.backgroundColor = '#e6ffe6';
        mensagem.innerHTML = `<strong>Processamento conclu√≠do com sucesso!</strong><br>Dados salvos e prontos para visualiza√ß√£o.`;

        // Countdown de 5 segundos antes de redirecionar
        let timeLeft = 5;
        const countdownInterval = setInterval(() => {
          if (timeLeft > 0) {
            countdown.textContent = `Redirecionando em ${timeLeft}s...`;
            timeLeft--;
          } else {
            clearInterval(countdownInterval);
            console.log('Redirecionando para dados.html...');
            window.location.href = `dados?t=${Date.now()}`;
          }
        }, 1000);

      } catch (erro) {
        console.error('Erro:', erro);
        clearInterval(progressInterval);
        
        // Resetar UI
        progressContainer.style.display = 'none';
        processingMessage.style.display = 'none';
        statsSummary.style.display = 'none';
        botao.disabled = false;
        botao.textContent = "Enviar Arquivo";
        
        mensagem.style.color = 'red';
        mensagem.style.backgroundColor = '#ffe6e6';
        mensagem.innerHTML = `<strong>Erro ao processar:</strong> ${erro.message}<br>Por favor, tente novamente.`;
      }
    });
  </script>
</body>
</html>