<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT ‚Äì Upload</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/732220.png') }}">
  <style>
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin-top: 15px;
      overflow: hidden;
      display: none;
      height: 30px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #e07b3c 0%, #cf6a2b 100%);
      text-align: center;
      line-height: 30px;
      color: white;
      font-weight: bold;
      transition: width 0.3s;
      width: 0%;
    }
    .countdown {
      font-size: 1.3em;
      color: #e07b3c;
      font-weight: bold;
      margin-top: 15px;
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #e07b3c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .processing-info {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
    }
    .processing-info h4 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    .processing-step {
      margin: 5px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .processing-step.active {
      background: #fff3cd;
      font-weight: bold;
    }
    .processing-step.done {
      background: #d4edda;
      color: #155724;
    }
    .stats-summary {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
    }
    .stats-summary h4 {
      margin: 0 0 10px 0;
      color: #0d47a1;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #bbdefb;
    }
    .stat-item:last-child {
      border-bottom: none;
    }
    .stat-label {
      font-weight: 500;
      color: #1976d2;
    }
    .stat-value {
      font-weight: bold;
      color: #0d47a1;
    }
  </style>
</head>
<body>
  <header>
    <div>FYT ‚Äì Find Your Talent</div>
    <div>Ol√°, Coordenador!</div>
  </header>

  <div class="container">
    <label>Selecione a sua √°rea:</label>
    <select id="areaSelect">
      <option>RH</option>
      <option>Cont√°bil</option>
      <option>Jur√≠dico</option>
      <option>TI</option>
      <option>Treinamento</option>
      <option>Compras</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <img src="../static/icons/732220.png" alt="CSV icon" style="width: 80px; height: 80px; margin: 20px auto; display: block;" />
    </div>

    <div class="format-info">Em formato .CSV</div>
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
    <div id="nome-arquivo" style="margin-top: 10px; font-weight: bold;"></div>

    <button id="botaoEnviar" style="margin-top: 20px; padding: 10px 20px; font-weight: bold; background-color: #e07b3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
      Enviar Arquivo
    </button>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="spinner" id="spinner"></div>

    <div class="processing-info" id="processingInfo">
      <h4>‚öôÔ∏è Processamento em andamento...</h4>
      <div id="processingSteps">
        <div class="processing-step" data-step="1">
          <span>‚è≥</span> Enviando arquivo...
        </div>
        <div class="processing-step" data-step="2">
          <span>‚è≥</span> Lendo dados da planilha
        </div>
        <div class="processing-step" data-step="3">
          <span>‚è≥</span> Calculando scores CHA
        </div>
        <div class="processing-step" data-step="4">
          <span>‚è≥</span> Identificando Top Performers
        </div>
        <div class="processing-step" data-step="5">
          <span>‚è≥</span> Analisando hobbies com IA Groq
        </div>
        <div class="processing-step" data-step="6">
          <span>‚è≥</span> Gerando relat√≥rios personalizados
        </div>
        <div class="processing-step" data-step="7">
          <span>‚è≥</span> Salvando no GitHub Gist
        </div>
      </div>
      <p style="margin: 15px 0 0 0; font-style: italic; text-align: center;">
        ‚ö†Ô∏è <strong>Aguarde!</strong> Isso pode levar at√© 3 minutos...
      </p>
    </div>

    <div class="stats-summary" id="statsSummary">
      <h4>üìä Resumo do Processamento</h4>
      <div id="statsContent"></div>
    </div>

    <div id="mensagem" style="margin-top: 15px; color: red;"></div>
    <div id="countdown" class="countdown"></div>
  </div>

  <script>
    let arquivoSelecionado = null;

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const nomeArquivo = document.getElementById("nome-arquivo");
      const mensagem = document.getElementById("mensagem");
      mensagem.textContent = "";

      if (!file) {
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      const extensao = file.name.split(".").pop().toLowerCase();
      if (extensao !== "csv") {
        mensagem.textContent = "Formato inv√°lido. Envie um arquivo .CSV.";
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      nomeArquivo.textContent = `Arquivo selecionado: ${file.name}`;
      arquivoSelecionado = file;
    });

    function updateStep(stepNumber, status) {
      const step = document.querySelector(`[data-step="${stepNumber}"]`);
      if (!step) return;

      step.classList.remove('active', 'done');
      
      if (status === 'active') {
        step.classList.add('active');
        step.querySelector('span').textContent = '‚öôÔ∏è';
      } else if (status === 'done') {
        step.classList.add('done');
        step.querySelector('span').textContent = '‚úÖ';
      }
    }

    function exibirEstatisticas(resultado) {
      const statsContent = document.getElementById('statsContent');
      const statsSummary = document.getElementById('statsSummary');
      
      let html = '';
      
      // Resumo Geral
      if (resultado.resumo) {
        html += `
          <div class="stat-item">
            <span class="stat-label">üìÅ Cen√°rios Processados:</span>
            <span class="stat-value">${resultado.resumo.total_cenarios || 0}</span>
          </div>
        `;
      }
      
      // Estat√≠sticas de Hobbies
      if (resultado.estatisticas_hobbies) {
        const stats = resultado.estatisticas_hobbies;
        html += `
          <div class="stat-item">
            <span class="stat-label">üë• Total Analisado:</span>
            <span class="stat-value">${stats.total_analisados || 0} funcion√°rios</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‚úÖ Sucesso (IA):</span>
            <span class="stat-value">${stats.total_sucesso || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‚ö†Ô∏è Erros:</span>
            <span class="stat-value">${stats.total_erros || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üí∞ Valor Total Sugerido:</span>
            <span class="stat-value">R$ ${(stats.valor_total_sugerido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üìà Taxa de Sucesso:</span>
            <span class="stat-value">${stats.taxa_sucesso || '0%'}</span>
          </div>
        `;
      }
      
      // Info do Gist
      if (resultado.gist_info && resultado.gist_info.url) {
        html += `
          <div class="stat-item" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #2196F3;">
            <span class="stat-label">üîó GitHub Gist:</span>
            <a href="${resultado.gist_info.url}" target="_blank" style="color: #1976d2; font-weight: bold;">Acessar Relat√≥rios</a>
          </div>
        `;
      }
      
      statsContent.innerHTML = html;
      statsSummary.style.display = 'block';
    }

    document.getElementById("botaoEnviar").addEventListener("click", async function () {
      const mensagem = document.getElementById("mensagem");
      const botao = document.getElementById("botaoEnviar");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const spinner = document.getElementById("spinner");
      const processingInfo = document.getElementById("processingInfo");
      const countdown = document.getElementById("countdown");
      const statsSummary = document.getElementById("statsSummary");
      
      mensagem.style.color = 'red';
      mensagem.textContent = "";
      countdown.textContent = "";
      statsSummary.style.display = 'none';

      if (!arquivoSelecionado) {
        mensagem.textContent = "Nenhum arquivo foi selecionado.";
        return;
      }

      // Desabilitar bot√£o e mostrar progresso
      botao.disabled = true;
      botao.style.opacity = '0.6';
      botao.style.cursor = 'not-allowed';
      progressContainer.style.display = 'block';
      spinner.style.display = 'block';
      processingInfo.style.display = 'block';

      // Simula√ß√£o de progresso visual
      let currentStep = 1;
      updateStep(1, 'active');

      const stepTimings = [
        { step: 1, progress: 10, time: 3000 },   // 3s - Upload
        { step: 2, progress: 20, time: 5000 },   // 5s - Leitura CSV
        { step: 3, progress: 35, time: 8000 },   // 8s - C√°lculo scores
        { step: 4, progress: 50, time: 10000 },  // 10s - Top Performers
        { step: 5, progress: 75, time: 60000 },  // 60s - IA Groq (LONGO!)
        { step: 6, progress: 90, time: 70000 },  // 70s - Relat√≥rios
        { step: 7, progress: 98, time: 80000 }   // 80s - Salvando
      ];

      let stepIndex = 0;
      const stepInterval = setInterval(() => {
        if (stepIndex < stepTimings.length) {
          const timing = stepTimings[stepIndex];
          
          if (currentStep > 1) {
            updateStep(currentStep - 1, 'done');
          }
          
          currentStep = timing.step;
          updateStep(currentStep, 'active');
          
          progressBar.style.width = timing.progress + '%';
          progressBar.textContent = timing.progress + '%';
          
          stepIndex++;
        }
      }, 10000); // Atualiza a cada 10 segundos

      try {
        const formData = new FormData();
        formData.append('file', arquivoSelecionado);
        formData.append('area', document.getElementById("areaSelect").value);

        console.log('üì§ Enviando arquivo para processamento...');
        const startTime = Date.now();

        // ‚ö†Ô∏è CR√çTICO: AGUARDAR resposta completa (timeout de 3 minutos)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutos
        
        const resposta = await fetch('https://iafyt5.app.n8n.cloud/webhook/upload-planilha', {
          method: 'POST',
          body: formData,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        clearInterval(stepInterval);

        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`‚è±Ô∏è Tempo total de processamento: ${elapsedTime}s`);

        if (!resposta.ok) {
          throw new Error(`HTTP ${resposta.status}: ${resposta.statusText}`);
        }

        // ‚úÖ AGUARDAR E PARSEAR RESPOSTA COMPLETA
        let resultado;
        try {
          resultado = await resposta.json();
          console.log('üìä Resultado completo recebido:', resultado);
        } catch (e) {
          console.error('‚ö†Ô∏è Erro ao parsear JSON da resposta:', e);
          throw new Error('Resposta inv√°lida do servidor');
        }

        // Validar se o processamento foi conclu√≠do com sucesso
        if (!resultado.sucesso) {
          throw new Error(resultado.mensagem || 'Processamento falhou sem mensagem de erro');
        }

        // Verificar se os dados foram salvos no GitHub Gist
        if (!resultado.gist_info || !resultado.gist_info.id) {
          console.error('‚ùå ERRO: Dados n√£o foram salvos no GitHub Gist');
          console.error('Resultado recebido:', resultado);
          throw new Error('Dados n√£o foram salvos no GitHub Gist. Verifique o workflow N8N.');
        }

        console.log('‚úÖ Gist salvo com sucesso! ID:', resultado.gist_info.id);
        console.log('üîó URL do Gist:', resultado.gist_info.url);

        // Marcar todas etapas como conclu√≠das
        for (let i = 1; i <= 7; i++) {
          updateStep(i, 'done');
        }

        // Completar barra de progresso
        progressBar.style.width = '100%';
        progressBar.textContent = '‚úÖ Conclu√≠do!';
        progressBar.style.background = 'linear-gradient(135deg, #28a745 0%, #20a038 100%)';
        spinner.style.display = 'none';

        // Exibir estat√≠sticas detalhadas
        if (resultado.estatisticas_hobbies) {
          exibirEstatisticas(resultado);
        }

        // Mensagem de sucesso detalhada
        const totalAnalises = resultado.estatisticas_hobbies?.total_analisados || 0;
        const totalSucesso = resultado.estatisticas_hobbies?.total_sucesso || 0;
        const taxaSucesso = resultado.estatisticas_hobbies?.taxa_sucesso || '0%';
        const valorTotal = resultado.estatisticas_hobbies?.valor_total_sugerido || 0;
        
        mensagem.style.color = 'green';
        mensagem.innerHTML = `
          ‚úÖ <strong>Processamento conclu√≠do com sucesso em ${elapsedTime}s!</strong><br>
          ü§ñ ${totalAnalises} an√°lises de IA realizadas (${totalSucesso} sucesso)<br>
          üìà Taxa de sucesso: ${taxaSucesso}<br>
          üí∞ Valor total sugerido: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
          üìÅ <a href="${resultado.gist_info.url}" target="_blank" style="color: #1976d2; font-weight: bold;">Ver todos os relat√≥rios no GitHub Gist</a>
        `;

        console.log('‚úÖ SUCESSO TOTAL! Dados confirmados no Gist. Preparando redirecionamento...');

        // ‚è∞ Countdown para redirecionamento (dados est√£o salvos e confirmados!)
        let timeLeft = 3;
        const countdownInterval = setInterval(() => {
          if (timeLeft > 0) {
            countdown.textContent = `Redirecionando para visualiza√ß√£o em ${timeLeft}s...`;
            timeLeft--;
          } else {
            clearInterval(countdownInterval);
            console.log('üîÑ Redirecionando para dados.html...');
            window.location.href = `dados?t=${Date.now()}`;
          }
        }, 1000);

      } catch (erro) {
        console.error('‚ùå ERRO COMPLETO:', erro);
        clearInterval(stepInterval);
        
        // Resetar UI em caso de erro
        progressContainer.style.display = 'none';
        spinner.style.display = 'none';
        processingInfo.style.display = 'none';
        statsSummary.style.display = 'none';
        botao.disabled = false;
        botao.style.opacity = '1';
        botao.style.cursor = 'pointer';
        
        // Resetar etapas visuais
        document.querySelectorAll('.processing-step').forEach(step => {
          step.classList.remove('active', 'done');
          step.querySelector('span').textContent = '‚è≥';
        });
        
        // Mensagem de erro detalhada
        let mensagemErro = erro.message;
        let dicaErro = '';
        
        if (erro.name === 'AbortError') {
          mensagemErro = 'Timeout: O processamento demorou mais de 3 minutos';
          dicaErro = 'O arquivo pode ser muito grande ou a API de IA est√° lenta. Tente novamente.';
        } else if (mensagemErro.includes('Gist')) {
          dicaErro = 'Verifique se o workflow N8N est√° salvando os dados corretamente no GitHub Gist.';
        } else if (mensagemErro.includes('HTTP')) {
          dicaErro = 'Erro de comunica√ß√£o com o servidor. Verifique sua conex√£o e tente novamente.';
        } else {
          dicaErro = 'Verifique se o arquivo CSV est√° no formato correto e tente novamente.';
        }
        
        mensagem.style.color = 'red';
        mensagem.innerHTML = `
          ‚ùå <strong>Falha ao processar arquivo</strong><br>
          <strong>Erro:</strong> ${mensagemErro}<br>
          üí° <strong>Dica:</strong> ${dicaErro}<br>
          <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #e07b3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
            üîÑ Tentar Novamente
          </button>
        `;
      }
    });
  </script>
</body>
</html>