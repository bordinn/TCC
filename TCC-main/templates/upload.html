<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT ‚Äì Upload</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    header {
      background-color: #e07b3c;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      max-width: 600px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    select {
      width: 100%;
      padding: 10px;
      margin: 10px 0 20px 0;
      border: 2px solid #ddd;
      font-size: 16px;
    }

    .upload-box {
      border: 3px dashed #e07b3c;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      background-color: #fff8f3;
    }

    .upload-box:hover {
      background-color: #ffe8d9;
    }

    .format-info {
      text-align: center;
      color: #666;
      margin-top: 10px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      background-color: #e07b3c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }

    button:hover:not(:disabled) {
      background-color: #cf6a2b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* BARRA DE PROGRESSO - SEM ARREDONDAMENTO, MAIS GROSSA */
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      margin-top: 20px;
      display: none;
      height: 40px; /* Mais grossa */
      border: 2px solid #333; /* Borda para destaque */
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #e07b3c 0%, #cf6a2b 100%);
      text-align: center;
      line-height: 40px;
      color: white;
      font-weight: bold;
      font-size: 18px;
      transition: width 0.5s linear;
      width: 0%;
    }

    .processing-info {
      background-color: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .processing-info h4 {
      margin: 0 0 15px 0;
      color: #856404;
      font-size: 18px;
    }

    .processing-step {
      margin: 8px 0;
      padding: 12px;
      background: white;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
    }

    .processing-step.active {
      background: #fff3cd;
      font-weight: bold;
      border-left: 4px solid #ffc107;
    }

    .processing-step.done {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .stats-summary {
      background: #e7f3ff;
      border-left: 5px solid #2196F3;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .stats-summary h4 {
      margin: 0 0 15px 0;
      color: #0d47a1;
      font-size: 18px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #bbdefb;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #1976d2;
    }

    .stat-value {
      font-weight: bold;
      color: #0d47a1;
    }

    .countdown {
      font-size: 1.5em;
      color: #e07b3c;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }

    #mensagem {
      margin-top: 20px;
      padding: 15px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div>FYT ‚Äì Find Your Talent</div>
    <div>Ol√°, Coordenador!</div>
  </header>

  <div class="container">
    <label>Selecione a sua √°rea:</label>
    <select id="areaSelect">
      <option>RH</option>
      <option>Cont√°bil</option>
      <option>Jur√≠dico</option>
      <option>TI</option>
      <option>Treinamento</option>
      <option>Compras</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <div style="font-size: 60px;">üìÑ</div>
      <div style="margin-top: 10px; font-size: 16px; color: #666;">Clique para selecionar arquivo CSV</div>
    </div>

    <div class="format-info">Formato aceito: .CSV</div>
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
    <div id="nome-arquivo" style="margin-top: 15px; font-weight: bold; color: #333;"></div>

    <button id="botaoEnviar">
      Enviar Arquivo
    </button>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="processing-info" id="processingInfo">
      <h4>‚öôÔ∏è Processamento em andamento...</h4>
      <div id="processingSteps">
        <div class="processing-step" data-step="1">
          <span>‚è≥</span> Enviando arquivo para servidor
        </div>
        <div class="processing-step" data-step="2">
          <span>‚è≥</span> Lendo e validando dados CSV
        </div>
        <div class="processing-step" data-step="3">
          <span>‚è≥</span> Calculando scores CHA (Conceito, Habilidade, Atitude)
        </div>
        <div class="processing-step" data-step="4">
          <span>‚è≥</span> Identificando Top Performers por cen√°rio
        </div>
        <div class="processing-step" data-step="5">
          <span>‚è≥</span> Analisando hobbies com IA Groq
        </div>
        <div class="processing-step" data-step="6">
          <span>‚è≥</span> Gerando relat√≥rios personalizados
        </div>
        <div class="processing-step" data-step="7">
          <span>‚è≥</span> Salvando dados no GitHub Gist
        </div>
      </div>
      <p style="margin: 20px 0 0 0; font-style: italic; text-align: center; font-size: 15px;">
        ‚è∞ <strong>Tempo estimado: 40 segundos</strong>
      </p>
    </div>

    <div class="stats-summary" id="statsSummary">
      <h4>üìä Resumo do Processamento</h4>
      <div id="statsContent"></div>
    </div>

    <div id="mensagem"></div>
    <div id="countdown" class="countdown"></div>
  </div>

  <script>
    let arquivoSelecionado = null;

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const nomeArquivo = document.getElementById("nome-arquivo");
      const mensagem = document.getElementById("mensagem");
      mensagem.textContent = "";
      mensagem.style.backgroundColor = "";

      if (!file) {
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      const extensao = file.name.split(".").pop().toLowerCase();
      if (extensao !== "csv") {
        mensagem.textContent = "‚ùå Formato inv√°lido. Envie um arquivo .CSV.";
        mensagem.style.color = "red";
        mensagem.style.backgroundColor = "#ffe6e6";
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      nomeArquivo.textContent = `üìÅ Arquivo selecionado: ${file.name}`;
      arquivoSelecionado = file;
    });

    function updateStep(stepNumber, status) {
      const step = document.querySelector(`[data-step="${stepNumber}"]`);
      if (!step) return;

      step.classList.remove('active', 'done');
      
      if (status === 'active') {
        step.classList.add('active');
        step.querySelector('span').textContent = '‚öôÔ∏è';
      } else if (status === 'done') {
        step.classList.add('done');
        step.querySelector('span').textContent = '‚úÖ';
      }
    }

    function exibirEstatisticas(resultado) {
      const statsContent = document.getElementById('statsContent');
      const statsSummary = document.getElementById('statsSummary');
      
      let html = '';
      
      if (resultado.resumo) {
        html += `
          <div class="stat-item">
            <span class="stat-label">üìÅ Cen√°rios Processados:</span>
            <span class="stat-value">${resultado.resumo.total_cenarios || 0}</span>
          </div>
        `;
      }
      
      if (resultado.estatisticas_hobbies) {
        const stats = resultado.estatisticas_hobbies;
        html += `
          <div class="stat-item">
            <span class="stat-label">üë• Total Analisado:</span>
            <span class="stat-value">${stats.total_analisados || 0} funcion√°rios</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üí∞ Valor Total Sugerido:</span>
            <span class="stat-value">R$ ${(stats.valor_total_sugerido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‚úÖ Taxa de Sucesso:</span>
            <span class="stat-value">${stats.taxa_sucesso || '0%'}</span>
          </div>
        `;
      }
      
      if (resultado.gist_info && resultado.gist_info.url) {
        html += `
          <div class="stat-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #2196F3;">
            <span class="stat-label">üîó GitHub Gist:</span>
            <a href="${resultado.gist_info.url}" target="_blank" style="color: #1976d2; font-weight: bold; text-decoration: underline;">Acessar Relat√≥rios</a>
          </div>
        `;
      }
      
      statsContent.innerHTML = html;
      statsSummary.style.display = 'block';
    }

    document.getElementById("botaoEnviar").addEventListener("click", async function () {
      const mensagem = document.getElementById("mensagem");
      const botao = document.getElementById("botaoEnviar");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const processingInfo = document.getElementById("processingInfo");
      const countdown = document.getElementById("countdown");
      const statsSummary = document.getElementById("statsSummary");
      
      mensagem.textContent = "";
      mensagem.style.backgroundColor = "";
      countdown.textContent = "";
      statsSummary.style.display = 'none';

      if (!arquivoSelecionado) {
        mensagem.textContent = "‚ùå Nenhum arquivo foi selecionado.";
        mensagem.style.color = "red";
        mensagem.style.backgroundColor = "#ffe6e6";
        return;
      }

      // Desabilitar bot√£o
      botao.disabled = true;
      botao.textContent = "Processando...";
      
      // Mostrar UI de progresso
      progressContainer.style.display = 'block';
      processingInfo.style.display = 'block';

      // PROGRESSO SIMULADO DE 40 SEGUNDOS
      const DURACAO_TOTAL = 40000; // 40 segundos
      const INTERVALO = 100; // Atualiza a cada 100ms
      const TOTAL_UPDATES = DURACAO_TOTAL / INTERVALO;
      
      let currentUpdate = 0;
      let currentStep = 1;

      // Define quando cada etapa come√ßa (em % do progresso)
      const stepBreakpoints = [
        { step: 1, startPercent: 0 },   // 0-10%
        { step: 2, startPercent: 10 },  // 10-20%
        { step: 3, startPercent: 20 },  // 20-35%
        { step: 4, startPercent: 35 },  // 35-50%
        { step: 5, startPercent: 50 },  // 50-70%
        { step: 6, startPercent: 70 },  // 70-85%
        { step: 7, startPercent: 85 }   // 85-100%
      ];

      const progressInterval = setInterval(() => {
        currentUpdate++;
        const percentComplete = (currentUpdate / TOTAL_UPDATES) * 100;
        
        // Atualizar barra
        progressBar.style.width = percentComplete + '%';
        progressBar.textContent = Math.floor(percentComplete) + '%';
        
        // Atualizar etapa ativa
        for (let i = stepBreakpoints.length - 1; i >= 0; i--) {
          if (percentComplete >= stepBreakpoints[i].startPercent) {
            if (currentStep !== stepBreakpoints[i].step) {
              if (currentStep > 0) {
                updateStep(currentStep, 'done');
              }
              currentStep = stepBreakpoints[i].step;
              updateStep(currentStep, 'active');
            }
            break;
          }
        }
        
        if (currentUpdate >= TOTAL_UPDATES) {
          clearInterval(progressInterval);
        }
      }, INTERVALO);

      try {
        const formData = new FormData();
        formData.append('file', arquivoSelecionado);
        formData.append('area', document.getElementById("areaSelect").value);

        console.log('üì§ Enviando arquivo para n8n...');
        const startTime = Date.now();

        // Fazer requisi√ß√£o (mas n√£o esperar resposta imediata)
        const resposta = await fetch('https://iafyt5.app.n8n.cloud/webhook/upload-planilha', {
          method: 'POST',
          body: formData
        });

        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`‚è±Ô∏è Upload conclu√≠do em: ${elapsedTime}s`);

        // Aguardar os 40 segundos completos antes de processar resposta
        const tempoRestante = DURACAO_TOTAL - (Date.now() - startTime);
        if (tempoRestante > 0) {
          console.log(`‚è≥ Aguardando mais ${(tempoRestante/1000).toFixed(1)}s...`);
          await new Promise(resolve => setTimeout(resolve, tempoRestante));
        }

        clearInterval(progressInterval);

        // Marcar todas etapas como conclu√≠das
        for (let i = 1; i <= 7; i++) {
          updateStep(i, 'done');
        }

        progressBar.style.width = '100%';
        progressBar.textContent = '‚úÖ 100% - Conclu√≠do!';

        // Processar resposta
        let resultado;
        try {
          resultado = await resposta.json();
          console.log('üìä Resultado:', resultado);
        } catch (e) {
          console.warn('‚ö†Ô∏è Resposta n√£o √© JSON, continuando...');
          resultado = { sucesso: true };
        }

        // Exibir estat√≠sticas se dispon√≠vel
        if (resultado && resultado.estatisticas_hobbies) {
          exibirEstatisticas(resultado);
        }

        // Mensagem de sucesso
        mensagem.style.color = 'green';
        mensagem.style.backgroundColor = '#e6ffe6';
        mensagem.innerHTML = `‚úÖ <strong>Processamento conclu√≠do com sucesso!</strong><br>Dados salvos e prontos para visualiza√ß√£o.`;

        // Countdown de 5 segundos antes de redirecionar
        let timeLeft = 5;
        const countdownInterval = setInterval(() => {
          if (timeLeft > 0) {
            countdown.textContent = `üîÑ Redirecionando em ${timeLeft}s...`;
            timeLeft--;
          } else {
            clearInterval(countdownInterval);
            console.log('üîÑ Redirecionando para dados.html...');
            window.location.href = `dados?t=${Date.now()}`;
          }
        }, 1000);

      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        clearInterval(progressInterval);
        
        // Resetar UI
        progressContainer.style.display = 'none';
        processingInfo.style.display = 'none';
        statsSummary.style.display = 'none';
        botao.disabled = false;
        botao.textContent = "Enviar Arquivo";
        
        // Resetar etapas
        document.querySelectorAll('.processing-step').forEach(step => {
          step.classList.remove('active', 'done');
          step.querySelector('span').textContent = '‚è≥';
        });
        
        mensagem.style.color = 'red';
        mensagem.style.backgroundColor = '#ffe6e6';
        mensagem.innerHTML = `‚ùå <strong>Erro ao processar:</strong> ${erro.message}<br>Por favor, tente novamente.`;
      }
    });
  </script>
</body>
</html>