<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYT ‚Äì Upload</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/732220.png') }}">
  <style>
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin-top: 15px;
      overflow: hidden;
      display: none;
      height: 30px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #e07b3c 0%, #cf6a2b 100%);
      text-align: center;
      line-height: 30px;
      color: white;
      font-weight: bold;
      transition: width 0.3s;
      width: 0%;
    }
    .countdown {
      font-size: 1.3em;
      color: #e07b3c;
      font-weight: bold;
      margin-top: 15px;
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #e07b3c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .processing-info {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
    }
    .processing-info h4 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    .processing-info ul {
      margin: 5px 0;
      padding-left: 20px;
      color: #856404;
    }
  </style>
</head>
<body>
  <header>
    <div>FYT ‚Äì Find Your Talent</div>
    <div>Ol√°, Coordenador!</div>
  </header>

  <div class="container">
    <label>Selecione a sua √°rea:</label>
    <select id="areaSelect">
      <option>RH</option>
      <option>Cont√°bil</option>
      <option>Jur√≠dico</option>
      <option>TI</option>
      <option>Treinamento</option>
      <option>Compras</option>
    </select>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <img src="../static/icons/732220.png" alt="CSV icon" style="width: 80px; height: 80px; margin: 20px auto; display: block;" />
    </div>

    <div class="format-info">Em formato .CSV</div>
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
    <div id="nome-arquivo" style="margin-top: 10px; font-weight: bold;"></div>

    <button id="botaoEnviar" style="margin-top: 20px; padding: 10px 20px; font-weight: bold; background-color: #e07b3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
      Enviar Arquivo
    </button>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="spinner" id="spinner"></div>

    <div class="processing-info" id="processingInfo">
      <h4>‚öôÔ∏è Processamento em andamento...</h4>
      <ul>
        <li>‚úì Lendo dados da planilha</li>
        <li>‚úì Calculando scores CHA</li>
        <li>‚úì Identificando Top Performers</li>
        <li>üéÅ Analisando hobbies com IA Gemini</li>
        <li>üíæ Gerando relat√≥rios personalizados</li>
      </ul>
      <p style="margin: 10px 0 0 0; font-style: italic;">Isso pode levar at√© 1 minuto...</p>
    </div>

    <div id="mensagem" style="margin-top: 15px; color: red;"></div>
    <div id="countdown" class="countdown"></div>
  </div>

  <script>
    let arquivoSelecionado = null;

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const nomeArquivo = document.getElementById("nome-arquivo");
      const mensagem = document.getElementById("mensagem");
      mensagem.textContent = "";

      if (!file) {
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      const extensao = file.name.split(".").pop().toLowerCase();
      if (extensao !== "csv") {
        mensagem.textContent = "Formato inv√°lido. Envie um arquivo .CSV.";
        nomeArquivo.textContent = "";
        arquivoSelecionado = null;
        return;
      }

      nomeArquivo.textContent = `Arquivo selecionado: ${file.name}`;
      arquivoSelecionado = file;
    });

    document.getElementById("botaoEnviar").addEventListener("click", async function () {
      const mensagem = document.getElementById("mensagem");
      const botao = document.getElementById("botaoEnviar");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const spinner = document.getElementById("spinner");
      const processingInfo = document.getElementById("processingInfo");
      const countdown = document.getElementById("countdown");
      
      mensagem.style.color = 'red';
      mensagem.textContent = "";
      countdown.textContent = "";

      if (!arquivoSelecionado) {
        mensagem.textContent = "Nenhum arquivo foi selecionado.";
        return;
      }

      // Desabilitar bot√£o e mostrar progresso
      botao.disabled = true;
      botao.style.opacity = '0.6';
      botao.style.cursor = 'not-allowed';
      progressContainer.style.display = 'block';
      spinner.style.display = 'block';
      processingInfo.style.display = 'block';

      // Simula√ß√£o de progresso
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 85) progress = 85; // Deixa em 85% at√© confirmar sucesso
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
      }, 2000);

      try {
        const formData = new FormData();
        formData.append('file', arquivoSelecionado);
        formData.append('area', document.getElementById("areaSelect").value);

        console.log('üì§ Enviando arquivo para processamento...');

        const resposta = await fetch('https://iafyt5.app.n8n.cloud/webhook/upload-planilha', {
          method: 'POST',
          body: formData
        });

        // Parar simula√ß√£o de progresso
        clearInterval(progressInterval);

        if (!resposta.ok) {
          throw new Error("Erro ao enviar para o workflow do n8n");
        }

        // Sucesso - completar barra de progresso
        progressBar.style.width = '100%';
        progressBar.textContent = '100% - Conclu√≠do!';
        spinner.style.display = 'none';
        processingInfo.style.display = 'none';

        mensagem.style.color = 'green';
        mensagem.textContent = "‚úÖ Arquivo processado com sucesso! An√°lise de IA conclu√≠da.";

        console.log('‚úÖ Processamento conclu√≠do. Iniciando redirecionamento...');

        // Countdown de 3 segundos
        let timeLeft = 3;
        const countdownInterval = setInterval(() => {
          if (timeLeft > 0) {
            countdown.textContent = `Redirecionando em ${timeLeft}...`;
            timeLeft--;
          } else {
            clearInterval(countdownInterval);
            console.log('üîÑ Redirecionando para dados.html com timestamp...');
            // Adiciona timestamp para for√ßar reload dos dados
            window.location.href = `dados?t=${Date.now()}`;
          }
        }, 1000);

      } catch (erro) {
        console.error('‚ùå Erro no upload:', erro);
        clearInterval(progressInterval);
        
        // Resetar UI
        progressContainer.style.display = 'none';
        spinner.style.display = 'none';
        processingInfo.style.display = 'none';
        botao.disabled = false;
        botao.style.opacity = '1';
        botao.style.cursor = 'pointer';
        
        mensagem.style.color = 'red';
        mensagem.textContent = "‚ùå Falha ao enviar o arquivo para o workflow. Tente novamente.";
      }
    });
  </script>
</body>
</html>